---
title: "Bayesian Assurance, Time-to-Event Outcome"
author: "J. Kyle Wathen and Laurent Spiess"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document: default
  word_document: default
---

<div class="alert alert-primary" role="alert">
<p style="margin-bottom:0">This example is related to both the <a href="IntegrationPointResponseTimeToEvent.html" class="alert-link">**Integration Point: Response - Time-to-Event Outcome**</a> and the <a href="IntegrationPointAnalysisTimeToEvent.html" class="alert-link">**Integration Point: Analysis - Time-to-Event Outcome**</a>. Click the links for setup instructions, variable details, and additional information about the integration points.</p>
</div>

<div class="alert alert-danger" role="alert">
To try this example, create a new project in East Horizon using the following configuration:
<ul style="margin-bottom:0">
<li>**Study objective:** Two Arm Confirmatory</li>
<li>**Number of endpoints:** Single Endpoint</li>
<li>**Endpoint type:** Time-to-Event Outcome</li>
<li>**Task:** Explore</li>
</ul></div>

<div class="alert alert-warning" role="alert">
<p style="margin-bottom:0">**Note:** This example is compatible with both Fixed Sample and Group Sequential statistical designs. The R code automatically detects whether interim look information (*LookInfo*) is available and adjusts the analysis parameters accordingly.</p>
</div>

# Introduction

The intent of the following examples is to demonstrate the computation of Bayesian assurance, or probability of success, through the integration of R with Cytel products. The examples feature a two-arm trial with time-to-event outcomes, using a **bi-modal distribution** prior to compute assurance.

The scenarios covered are as follows:

1. Fixed sample design using a bi-modal distribution and Cox proportional hazards model to compute Bayesian assurance.

Once CyneRgy is installed, you can load this example in RStudio with the following commands:
```{r, eval=FALSE}
CyneRgy::RunExample( "BayesianAssuranceTimeToEvent" )
```

Running the command above will load the RStudio project in RStudio. 

In the [R directory of this example](https://github.com/Cytel-Inc/CyneRgy/tree/main/inst/Examples/BayesianAssuranceContinuous/R) you will find the R files used in the examples:

1. [SimulatePatientSurvivalAssurance.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceTimeToEvent/R/SimulatePatientOutcomeNormalAssurance.R) - Functions to simulate patient outcomes under a time-to-event distribution informed by a bi-modal prior.
2. [AnalyzeSurvivalDataUsingCoxPH.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceTimeToEvent/R/AnalyzeUsingBayesianNormals.R) - Implements Bayesian analysis of simulated outcomes using Cox proportional hazards model.

# Example 1 - Fixed Sample Design

This example considers a two-arm fixed sample design with a time-to-event endpoint, with 300 patients per arm. It demonstrates how to customize the the **Response (Patient Simulation)** element of East Horizon's simulation to simulate the true hazard ratio from the prior and then simulate the patient data using the sampled hazard ratio, and the **Analysis** element of East Horizon's simulation to perform the analysis using a Cox model.

The figure below illustrates where this example fits within the R integration points of Cytel products, accompanied by flowcharts outlining the general steps performed by the R code.

```{r echo=FALSE,  warning=FALSE, fig.retina=3}
CyneRgy::PlotExampleFlowchart(
    lIntPoints = list(
        "Response" = c(
            "Load prior distribution parameters, scaling bounds, and mean TTE", 
            "Sample from prior distribution for log hazard ratio",
            "Compute true hazard rates",
            "Simulate patient survival times based on treatment assignment",
            "Return simulated survival times and true hazard ratio"
        ),
        "Analysis" = c(
            "Load survival data and user-defined parameters",
            "Fit Cox proportional hazards model to observed data",
            "Compute z-statistic and p-value from Cox model",
            "Make Go/No-Go decision based on p-value and alpha threshold",
            "Return test statistic, decision, p-value, and hazard ratio"
        )
    )
)
```

## Response (Patient Simulation) Integration Point

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This endpoint is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceTimeToEvent/R/SimulatePatientSurvivalAssurance.R" class="alert-link">SimulatePatientSurvivalAssurance.R</a></p>
</div>

This function simulates patient-level outcomes within a **Bayesian assurance framework**. Information generated from this simulation will be used later for the [Analysis Integration Point](#analysis-integration-point). In this example, a **bi-modal prior** on the $\log(HR)$ is used. The components of the prior are:
 
- 25% weight on $\mathcal{N}(0, 0.02)$.
- 75% weight on $\mathcal{Beta}(2, 2)$, rescaled between -0.4 and 0.

```{r echo=FALSE,  warning=FALSE}

######################################################################################################################## .
# Plot the assurance prior ####
######################################################################################################################## .
vMean1 <- rnorm(250000, mean = 0,   sd = 0.02)

vMean2 <- 0.4*rbeta( 750000, 2, 2 ) - 0.4


vMean    <- c( vMean1, vMean2 )
dfSample <- data.frame( SampleMean = vMean )

dfDensity   <- density( dfSample$SampleMean)
vY <- dfDensity$y/max( dfDensity$y )
vX <- dfDensity$x 

dfDensity <- data.frame( y = vY, x = vX)

# Assuming dfSample is your data frame
# Adjusted ggplot code
ggplot(dfDensity, aes(x = x, y = y)) +
    geom_area( fill = "skyblue", color = "black") +
    labs(title = expression("Assurance Prior Distribution of True Log(HR)" ), 
             x = expression( "True Log(HR) "  ), y ="Density") +
    theme_bw() +
    theme(
        plot.title = element_text(hjust = 0.5),  # Center the title
        axis.text.x = element_text(size = 10),    # Adjust x-axis text size
        axis.title.x = element_text(size = 12),   # Adjust x-axis title size
        axis.title.y = element_text(size = 12),   # Adjust y-axis title size
        plot.margin = margin(20, 20, 20, 20),      # Adjust plot margins
        #panel.grid.major = element_blank(),        # Remove major grid lines
        #panel.grid.minor = element_blank(),        # Remove minor grid lines
        panel.border = element_blank(),            # Remove panel border
        axis.line = element_line(color = "black")  # Add black axis line
    ) +
    xlim(-0.4, 0.1)  # Set x-axis range from 0 to 1
```

Refer to the table below for the definitions and values of the user-defined parameters used in this example.

|**User parameter**|**Definition**|**Value**|
|--|------|--|
|**dWeight1**|Probability of using the normal prior for log(HR).|0.25|
|**dPriorMean**|Mean of the normal prior for log(HR).|0|
|**dPriorSD**|Standard deviation of the normal prior for log(HR).|0.02|
|**dAlpha**|Alpha parameter of the Beta prior for log(HR).|2|
|**dBeta**|Beta parameter of the Beta prior for log(HR).|2|
|**dUpper**|Upper bound for scaling the Beta prior.|0|
|**dLower**|Lower bound for scaling the Beta prior.|-0.4|
|**dMeanTTEControl**|Mean time-to-event for the control group.|12|

## Analysis Integration Point

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This endpoint is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceTimeToEvent/R/AnalyzeSurvivalDataUsingCoxPH.R" class="alert-link">AnalyzeSurvivalDataUsingCoxPH.R</a></p>
</div>

A single analysis is conducted once 50% of patients have experienced the event of interest. Using the function in the file, the analysis employs a **Cox proportional hazards model**, with a hazard ratio (HR) less than 1 indicating a benefit in favor of the experimental arm. It uses information from the simulation that is generated by the [Response](#response-patient-simulation-integration-point) element of East Horizon's simulation, explained above. A Go decision is made if the resulting p-value is less than or equal to 0.025. Refer to the table below for the definitions of the user-defined parameters used in this example.

|**User parameter**|**Definition**|
|---|------|
|**bReturnLogTrueHazard**|If `True`, the function returns the natural logarithm of the true hazard ratio instead of its raw value.|
|**bReturnNAForNoGoTrials**|If `True` and the trial does not meet the Go decision criterion, the function returns `NA` for the hazard ratio.|

## Results

```{r  echo=FALSE,  warning=FALSE, include = FALSE}
######################################################################################################################## .
# Example 3 Post Process                                                                                               ####
# This file provides functions and R Code example to post process the East output for useful graphs and numeric values ####
# 
######################################################################################################################## .
library(readr)

dfEastResultsEx1 <- read_csv("Outputs/Example1/Example1.csv")
vGo       <- ifelse( dfEastResultsEx1$BdryStopCode == 2, 1, 0)
dProbGo   <- mean( vGo )  # Pr( Go )
```

The probability of a Go decision is `r round( dProbGo*100, 0)`% and the probability of a No-Go Decision is  is `r 100 - round( dProbGo*100, 0)`%. The posterior distribution of the true $\log( HR )$ given a Go decision is:

```{r echo = FALSE, warning = FALSE}
# Get trials that are successful so we can build posterior of true delta when a Go decision is made
dfSuccess <- dfEastResultsEx1[ dfEastResultsEx1$BdryStopCode==2, ]
dfDensity <- density( log( dfSuccess$TrueHR) )

vY <- dfDensity$y
vX <- dfDensity$x 

dfPostDensity <- data.frame( y = vY, x = vX)

# Assuming dfPostDensity is your data frame
# Adjusted ggplot code
ggplot(dfPostDensity, aes(x = x, y = y)) +
    geom_area( fill = "skyblue", color = "black") +
    labs(title = expression("Assurance Posterior Distribution of True Log(HR)" ), 
             x = expression( "True Log(HR)"  ), y ="Density") +
    theme_bw() +
    theme(
        plot.title = element_text(hjust = 0.5),  # Center the title
        axis.text.x = element_text(size = 10),    # Adjust x-axis text size
        axis.title.x = element_text(size = 12),   # Adjust x-axis title size
        axis.title.y = element_text(size = 12),   # Adjust y-axis title size
        plot.margin = margin(20, 20, 20, 20),      # Adjust plot margins
        panel.border = element_blank(),            # Remove panel border
        axis.line = element_line(color = "black")  # Add black axis line
    ) +
    xlim(-0.4, 0.1)  # Set x-axis range from 0 to 1

vY <- dfDensity$y/max( dfDensity$y )
vX <- dfDensity$x 

dfPostDensity <- data.frame( y = vY, x = vX)

# Assuming dfPostDensity is your data frame
# Adjusted ggplot code
ggplot(dfPostDensity, aes(x = x, y = y)) +
    geom_area( fill = "skyblue", color = "black") +
    labs(title = expression("Scaled Assurance Posterior Distribution of True Log(HR)" ), 
             x = expression( "True Log(HR)"  ), y ="Density") +
    theme_bw() +
    theme(
        plot.title = element_text(hjust = 0.5),  # Center the title
        axis.text.x = element_text(size = 10),    # Adjust x-axis text size
        axis.title.x = element_text(size = 12),   # Adjust x-axis title size
        axis.title.y = element_text(size = 12),   # Adjust y-axis title size
        plot.margin = margin(20, 20, 20, 20),      # Adjust plot margins
        #panel.grid.major = element_blank(),        # Remove major grid lines
        #panel.grid.minor = element_blank(),        # Remove minor grid lines
        panel.border = element_blank(),            # Remove panel border
        axis.line = element_line(color = "black")  # Add black axis line
    ) +
    xlim(-0.4, 0.1)  # Set x-axis range from 0 to 1
```

# See Also

Other relevant examples include:

- [Bayesian Assurance, Continuous Outcome](BayesianAssuranceContinuous.html)
- [Consecutive Studies, Continuous Outcome](ConsecutiveStudiesContinuous.html)
- [Consecutive Studies, Continuous & Time-to-Event Outcomes](ConsecutiveStudiesContinuousTimeToEvent.html)
- [Consecutive Studies, Binary Outcome](ConsecutiveStudiesBinary.html)
- [Probability of Success, Dual Endpoints](ProbabilitySuccessDualEndpoints.html)
