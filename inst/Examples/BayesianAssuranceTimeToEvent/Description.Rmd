---
title: "Bayesian Assurance, Time-to-Event Outcome"
author: "J. Kyle Wathen and Laurent Spiess"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document: default
  word_document: default
---

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0">The following scripts are related to the <a href="IntegrationPointAnalysis.html" class="alert-link"><strong>Integration Point: Analysis</strong></a> and the <a href="IntegrationPointResponse.html" class="alert-link"><strong>Integration Point: Response</strong></a>. Click on the links for more information about these integration points.</p>
</div>

# Introduction

The intent of the following examples is to demonstrate the computation of Bayesian assurance, or probability of success, through the integration of R with Cytel products. The examples feature a two-arm trial with time-to-event outcomes, using a **bi-modal distribution** prior to compute assurance.

The scenarios covered are as follows:

1. Fixed sample design using a bi-modal distribution and Cox proportional hazards model to compute Bayesian assurance.

Once CyneRgy is installed, you can load this example in RStudio with the following commands:
```{r, eval=FALSE}
CyneRgy::RunExample( "BayesianAssuranceTimeToEvent" )
```

Running the command above will load the RStudio project in RStudio. 

In the [R directory of this example](https://github.com/Cytel-Inc/CyneRgy/tree/main/inst/Examples/BayesianAssuranceContinuous/R) you will find the R files used in the examples:

1. [SimulatePatientSurvivalAssurance.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceContinuous/R/SimulatePatientOutcomeNormalAssurance.R) - Functions to simulate patient outcomes under a time-to-event distribution informed by a bi-modal prior.
2. [AnalyzeSurvivalDataUsingCoxPH.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceContinuous/R/AnalyzeUsingBayesianNormals.R) - Implements Bayesian analysis of simulated outcomes using Cox proportional hazards model.

# Example 1 - Fixed Sample Design

This example considers a two-arm fixed sample design with a time-to-event endpoint, with 300 patients per arm. It demonstrates how to customize the the **Response (Patient Simulation)** element of East Horizon's simulation to simulate the true hazard ratio from the prior and then simulate the patient data using the sampled hazard ratio, and the **Analysis** element of East Horizon's simulation to perform the analysis using a Cox model.

The figure below illustrates where this example fits within the R integration points of Cytel products, accompanied by flowcharts outlining the general steps performed by the R code.

```{r echo=FALSE,  warning=FALSE, fig.retina=3}
library(ggplot2)
bigcolxmin = 5
bigcolxmax = bigcolxmin + 3
bigcolxmin2 = 8.5
bigcolxmax2 = bigcolxmin2 + 3
# Define main columns
columns <- data.frame(
  xmin = c(0, 1, 2, 3, 4, bigcolxmin, bigcolxmin2),
  xmax = c(0.5, 1.5, 2.5, 3.5, 4.5, bigcolxmax, bigcolxmax2),
  ymin = rep(3, 7),
  ymax = rep(10.75, 7),
  label = c("Initialization", "Enrollment", "Randomization", "Dropout", "Treatment\nSelection", "Response", "Analysis"),
  fill = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff"),
  border = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff")
)
unitybox = 0.7
spaceybox = 0.5
ymaxfirstbox = 10.5
yminfirstbox = ymaxfirstbox - unitybox*1.5
ymaxsecondbox = yminfirstbox - spaceybox
yminsecondbox = ymaxsecondbox - unitybox*1.5
ymaxthirdbox = yminsecondbox - spaceybox
yminthirdbox = ymaxthirdbox - unitybox
ymaxfourthbox = yminthirdbox - spaceybox
yminfourthbox = ymaxfourthbox - unitybox*1.5
ymaxfifthbox = yminfourthbox - spaceybox
yminfifthbox = ymaxfifthbox - unitybox*1.5
# Define flowchart steps 
flowchart <- data.frame(
  xmin = rep(bigcolxmin + 0.1, 5),
  xmax = rep(bigcolxmax - 0.1, 5),
  ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox, ymaxfifthbox),
  ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox, yminfifthbox),
  label = c("Load prior distribution parameters,\nscaling bounds, and mean TTE", 
            "Sample from prior distribution\nfor log hazard ratio",
            "Compute true hazard rates",
            "Simulate patient survival times\nbased on treatment assignment",
            "Return simulated survival times\nand true hazard ratio"),
  fill = rep("#cfe2ff", 5)
)
# Define arrows for flowchart 
flowchart_arrows <- data.frame(
  x = rep((bigcolxmin+bigcolxmax)/2, 4),
  xend = rep((bigcolxmin+bigcolxmax)/2, 4),
  y = c(flowchart$ymin[1], flowchart$ymin[2], flowchart$ymin[3], flowchart$ymin[4]),
  yend = c(flowchart$ymax[2], flowchart$ymax[3], flowchart$ymax[4], flowchart$ymax[5])
)
yminfirstbox2 = ymaxfirstbox - unitybox*1.5
ymaxsecondbox2 = yminfirstbox2 - spaceybox
yminsecondbox2 = ymaxsecondbox2 - unitybox*1.5
ymaxthirdbox2 = yminsecondbox2 - spaceybox
yminthirdbox2 = ymaxthirdbox2 - unitybox*1.5
ymaxfourthbox2 = yminthirdbox2 - spaceybox
yminfourthbox2 = ymaxfourthbox2 - unitybox*1.5
ymaxfifthbox2 = yminfourthbox2 - spaceybox
yminfifthbox2 = ymaxfifthbox2 - unitybox*1.5
# Define flowchart steps 
flowchart2 <- data.frame(
  xmin = rep(bigcolxmin2 + 0.1, 5),
  xmax = rep(bigcolxmax2 - 0.1, 5),
  ymax = c(ymaxfirstbox, ymaxsecondbox2, ymaxthirdbox2, ymaxfourthbox2, ymaxfifthbox2),
  ymin = c(yminfirstbox2, yminsecondbox2, yminthirdbox2, yminfourthbox2, yminfifthbox2),
  label = c("Load survival data\nand user-defined parameters",
            "Fit Cox proportional hazards model\nto observed data",
            "Compute z-statistic and p-value\nfrom Cox model",
            "Make Go/No-Go decision based on\np-value and alpha threshold",
            "Return test statistic, decision,\np-value, and hazard ratio"),
  fill = rep("#cfe2ff", 5)
)
# Define arrows for flowchart 
flowchart_arrows2 <- data.frame(
  x = rep((bigcolxmin2+bigcolxmax2)/2, 4),
  xend = rep((bigcolxmin2+bigcolxmax2)/2, 4),
  y = c(flowchart2$ymin[1], flowchart2$ymin[2], flowchart2$ymin[3], flowchart2$ymin[4]),
  yend = c(flowchart2$ymax[2], flowchart2$ymax[3], flowchart2$ymax[4], flowchart2$ymax[5])
)
# Define the legend elements
legend_data <- data.frame(
  xmin = c(9, 10.5),
  xmax = c(10, 11.5),
  ymin = c(2.5, 2.5),
  ymax = c(2.8, 2.8),
  fill = c("lightgray", "#cfe2ff"),
  label = c("Not Used", "Used")
)
# Create the plot
p <- ggplot() +
  # Add main column sections
  geom_rect(data = columns, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill),
            color = columns$border) + 
  scale_fill_identity() +
  # Add labels for the columns
  geom_text(data = columns, aes(x = (xmin + xmax) / 2, y = ymax + 0.7, label = label), size = 3, angle = 20, vjust = 1) +
  # Add flowchart 
  geom_rect(data = flowchart, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
  geom_text(data = flowchart, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
  # Add arrows between flowchart boxes
  geom_curve(data = flowchart_arrows, aes(x = x, y = y, xend = xend, yend = yend),
             curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
  # Add flowchart 
  geom_rect(data = flowchart2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
  geom_text(data = flowchart2, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
  # Add arrows between flowchart boxes
  geom_curve(data = flowchart_arrows2, aes(x = x, y = y, xend = xend, yend = yend),
             curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
  # Remove grid and axes
  theme_void() + 
  theme(panel.background = element_rect(fill = 'white', colour = 'white')) +
  geom_rect(data = legend_data, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
  geom_text(data = legend_data, aes(x = (xmin + xmax) / 2, y = ymin - 0.1, label = label), size = 2.5, vjust = 1) 
print(p)
```

## Response (Patient Simulation) Integration Point

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This endpoint is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceContinuous/R/SimulatePatientSurvivalAssurance.R" class="alert-link">SimulatePatientSurvivalAssurance.R</a></p>
</div>

This function simulates patient-level outcomes within a **Bayesian assurance framework**. Information generated from this simulation will be used later for the [Analysis Integration Point](#analysis-integration-point). In this example, a **bi-modal prior** on the $\log(HR)$ is used. The components of the prior are:
 
- 25% weight on $\mathcal{N}(0, 0.02)$.
- 75% weight on $\mathcal{Beta}(2, 2)$, rescaled between -0.4 and 0.

```{r echo=FALSE,  warning=FALSE}

######################################################################################################################## .
# Plot the assurance prior ####
######################################################################################################################## .
vMean1 <- rnorm(250000, mean = 0,   sd = 0.02)

vMean2 <- 0.4*rbeta( 750000, 2, 2 ) - 0.4


vMean    <- c( vMean1, vMean2 )
dfSample <- data.frame( SampleMean = vMean )

dfDensity   <- density( dfSample$SampleMean)
vY <- dfDensity$y/max( dfDensity$y )
vX <- dfDensity$x 

dfDensity <- data.frame( y = vY, x = vX)

# Assuming dfSample is your data frame
# Adjusted ggplot code
ggplot(dfDensity, aes(x = x, y = y)) +
    geom_area( fill = "skyblue", color = "black") +
    labs(title = expression("Assurance Prior Distribution of True Log(HR)" ), 
             x = expression( "True Log(HR) "  ), y ="Density") +
    theme_bw() +
    theme(
        plot.title = element_text(hjust = 0.5),  # Center the title
        axis.text.x = element_text(size = 10),    # Adjust x-axis text size
        axis.title.x = element_text(size = 12),   # Adjust x-axis title size
        axis.title.y = element_text(size = 12),   # Adjust y-axis title size
        plot.margin = margin(20, 20, 20, 20),      # Adjust plot margins
        #panel.grid.major = element_blank(),        # Remove major grid lines
        #panel.grid.minor = element_blank(),        # Remove minor grid lines
        panel.border = element_blank(),            # Remove panel border
        axis.line = element_line(color = "black")  # Add black axis line
    ) +
    xlim(-0.4, 0.1)  # Set x-axis range from 0 to 1
```

Refer to the table below for the definitions and values of the user-defined parameters used in this example.

|**User parameter**|**Definition**|**Value**|
|--|------|--|
|**dWeight1**|Probability of using the normal prior for log(HR).|0.25|
|**dPriorMean**|Mean of the normal prior for log(HR).|0|
|**dPriorSD**|Standard deviation of the normal prior for log(HR).|0.02|
|**dAlpha**|Alpha parameter of the Beta prior for log(HR).|2|
|**dBeta**|Beta parameter of the Beta prior for log(HR).|2|
|**dUpper**|Upper bound for scaling the Beta prior.|0|
|**dLower**|Lower bound for scaling the Beta prior.|-0.4|
|**dMeanTTEControl**|Mean time-to-event for the control group.|12|

## Analysis Integration Point

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This endpoint is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/BayesianAssuranceContinuous/R/AnalyzeSurvivalDataUsingCoxPH.R" class="alert-link">AnalyzeSurvivalDataUsingCoxPH.R</a></p>
</div>

A single analysis is conducted once 50% of patients have experienced the event of interest. Using the function in the file, the analysis employs a **Cox proportional hazards model**, with a hazard ratio (HR) less than 1 indicating a benefit in favor of the experimental arm. It uses information from the simulation that is generated by the [Response](#response-patient-simulation-integration-point) element of East Horizon's simulation, explained above. A Go decision is made if the resulting p-value is less than or equal to 0.025. Refer to the table below for the definitions of the user-defined parameters used in this example.

|**User parameter**|**Definition**|
|---|------|
|**bReturnLogTrueHazard**|If `True`, the function returns the natural logarithm of the true hazard ratio instead of its raw value.|
|**bReturnNAForNoGoTrials**|If `True` and the trial does not meet the Go decision criterion, the function returns `NA` for the hazard ratio.|

## Results

```{r  echo=FALSE,  warning=FALSE, include = FALSE}
######################################################################################################################## .
# Example 3 Post Process                                                                                               ####
# This file provides functions and R Code example to post process the East output for useful graphs and numeric values ####
# 
######################################################################################################################## .
library(readr)

dfEastResultsEx1 <- read_csv("Outputs/Example1/Example1.csv")
vGo       <- ifelse( dfEastResultsEx1$BdryStopCode == 2, 1, 0)
dProbGo   <- mean( vGo )  # Pr( Go )
```

The probability of a Go decision is `r round( dProbGo*100, 0)`% and the probability of a No-Go Decision is  is `r 100 - round( dProbGo*100, 0)`%. The posterior distribution of the true $\log( HR )$ given a Go decision is:

```{r echo = FALSE, warning = FALSE}
# Get trials that are successful so we can build posterior of true delta when a Go decision is made
dfSuccess <- dfEastResultsEx1[ dfEastResultsEx1$BdryStopCode==2, ]
dfDensity <- density( log( dfSuccess$TrueHR) )

vY <- dfDensity$y
vX <- dfDensity$x 

dfPostDensity <- data.frame( y = vY, x = vX)

# Assuming dfPostDensity is your data frame
# Adjusted ggplot code
ggplot(dfPostDensity, aes(x = x, y = y)) +
    geom_area( fill = "skyblue", color = "black") +
    labs(title = expression("Assurance Posterior Distribution of True Log(HR)" ), 
             x = expression( "True Log(HR)"  ), y ="Density") +
    theme_bw() +
    theme(
        plot.title = element_text(hjust = 0.5),  # Center the title
        axis.text.x = element_text(size = 10),    # Adjust x-axis text size
        axis.title.x = element_text(size = 12),   # Adjust x-axis title size
        axis.title.y = element_text(size = 12),   # Adjust y-axis title size
        plot.margin = margin(20, 20, 20, 20),      # Adjust plot margins
        panel.border = element_blank(),            # Remove panel border
        axis.line = element_line(color = "black")  # Add black axis line
    ) +
    xlim(-0.4, 0.1)  # Set x-axis range from 0 to 1

vY <- dfDensity$y/max( dfDensity$y )
vX <- dfDensity$x 

dfPostDensity <- data.frame( y = vY, x = vX)

# Assuming dfPostDensity is your data frame
# Adjusted ggplot code
ggplot(dfPostDensity, aes(x = x, y = y)) +
    geom_area( fill = "skyblue", color = "black") +
    labs(title = expression("Scaled Assurance Posterior Distribution of True Log(HR)" ), 
             x = expression( "True Log(HR)"  ), y ="Density") +
    theme_bw() +
    theme(
        plot.title = element_text(hjust = 0.5),  # Center the title
        axis.text.x = element_text(size = 10),    # Adjust x-axis text size
        axis.title.x = element_text(size = 12),   # Adjust x-axis title size
        axis.title.y = element_text(size = 12),   # Adjust y-axis title size
        plot.margin = margin(20, 20, 20, 20),      # Adjust plot margins
        #panel.grid.major = element_blank(),        # Remove major grid lines
        #panel.grid.minor = element_blank(),        # Remove minor grid lines
        panel.border = element_blank(),            # Remove panel border
        axis.line = element_line(color = "black")  # Add black axis line
    ) +
    xlim(-0.4, 0.1)  # Set x-axis range from 0 to 1
```

# See Also

Other relevant examples include:

- [Bayesian Assurance, Continuous Outcome](BayesianAssuranceContinuous.html)
- [Consecutive Studies, Continuous Outcome](ConsecutiveStudiesContinuous.html)
- [Consecutive Studies, Continuous & Time-to-Event Outcomes](ConsecutiveStudiesContinuousTimeToEvent.html)
- [Consecutive Studies, Binary Outcome](ConsecutiveStudiesBinary.html)
- [Probability of Success, Dual Endpoints](ProbabilitySuccessDualEndpoints.html)
