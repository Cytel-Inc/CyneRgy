---
title: 'Generate Patient Arrival Times with Poisson Process'
author: "J. Kyle Wathen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
---

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0">These examples are related to the <strong>Integration Point: Enrollment</strong>.
  <a href="IntegrationPointEnrollment.html" class="alert-link">Click here for more information about this integration point.</a></p>
</div>

# Introduction

The following examples demonstrate how to integrate the capability to generate patient arrival times following a Poisson process with a ramp-up phase into East Horizon or East using R functions. They showcase different approaches for simulating arrival times based on a Poisson process, offering flexibility in modeling patient recruitment dynamics.

Once CyneRgy is installed, you can load this example in RStudio with the following commands:
```{r, eval=FALSE}
CyneRgy::RunExample( "GeneratePoissonArrival" )
```

Running the command above will load the RStudio project in RStudio. 

**East Workbook**: [GeneratePoissonArrival.cywx](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/GeneratePoissonArrival/GeneratePoissonArrival.cywx)

**RStudio Project File**: [GeneratePoissonArrival.Rproj](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/GeneratePoissonArrival/GeneratePoissonArrival.Rproj)

In the [R directory of this example](https://github.com/Cytel-Inc/CyneRgy/tree/main/inst/Examples/GeneratePoissonArrival/R) you will find the following R file:

1. [GeneratePoissonArrival.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/GeneratePoissonArrival/R/GeneratePoissonArrival.R) - This file provides the code used for the two examples below.

# Example 1 - Ramp-Up In Accrual Using Built In Input

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This example is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/GeneratePoissonArrival/R/GeneratePoissonArrival.R" class="alert-link">GeneratePoissonArrival.R</a></p>
</div>

In this example, we use the built-in inputs of East Horizon or East to implement a user-specified ramp-up in accrual using Poisson. Suppose the user defines the start periods as 0, 6, 12, 18, 24, and 48 (*Starting at Time* in East Horizon, *PrdStart* in the R script) and specifies the expected accrual rates (*Average Subjects Enrolled* in East Horizon, *AccrRate* in the R script) as 1, 4, 12, 24, and 48. This means:

- From time 0 to 6, the expected accrual rate is 1 patient per time unit.
- From time 6 to 12, the rate increases to 4 patients per time unit.
- From time 12 to 18, the rate further increases to 12 patients per time unit.
- From time 18 to 24, the expected accrual rate is 24.
- After time unit 24, the accrual rate is assumed to be 48 patients per time unit.

This would yield accrual patterns resembling the following figure, with dashed lines marking the time points where accrual rates change:

```{r echo=FALSE,  warning=FALSE}
source("R/GeneratePoissonArrival.R")

par(bg = "white")  # Set background to white

NumSub   <- 600
NumPrd   <- 1  
AccrRate <- c( 1, 4, 12, 24, 48)
PrdStart <- c( 0, 6, 12, 18, 24 )
lRet2 <- GeneratePoissonArrival( NumSub, NumPrd, PrdStart, AccrRate  )
plot( lRet2$ArrivalTime , 1:NumSub, type = 'l', xlab = "Time",main = "Number of Patients Enrolled Using PrdStart and AccrRate", ylab = "Number of Patients Enrolled", ylim = c(0,300), xlim = c(0,26))
abline( v = PrdStart, lty =2)
```

This example does not use any user-defined parameters.

# Example 2 - Ramp-Up In Accrual Using UserParam

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This example is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/GeneratePoissonArrival/R/GeneratePoissonArrival.R" class="alert-link">GeneratePoissonArrival.R</a></p>
</div>

Now, let's extend this approach by incorporating custom variables (*UserParam*). In this example, we use a custom R script and specify seven accrual rates. When custom variables are provided, the built-in variables *PrdStart* and *AccrRate* are ignored. Refer to the table below for the definitions and values of the user-defined parameters used in this example.

|**User parameter**|**Definition**|**Value**|
|---|------|---|
|**Rate1**|Accural rate in the first unit of time|3|
|**Rate2**|Accural rate in the second unit of time|6|
|**Rate3**|Accural rate in the third unit of time|10|
|**Rate4**|Accural rate in the fourth unit of time|15|
|**Rate5**|Accural rate in the fifth unit of time|18|
|**Rate6**|Accural rate in the sixth unit of time|25|
|**Rate7**|Accural rate in the seventh unit of time|35|

Warning, the first time unit is 0, not 1. This means:

- At time 0, the accrual rate is *dRate1* (3) per unit time.
- At time 1, the rate changes to *dRate2* (6).
- At time 2, the rate changes to *dRate3* (10), and so on.
- After time 6, the accrual rate remains at *dRate7* (35).

For example, if the time unit is months, this setup models a ramp-up over a six-month period, with the accrual rate stabilizing at *dRate7* (35) from month 6 onward. This could produce an accrual pattern resembling the following:

```{r echo=FALSE,  warning=FALSE}
source("R/GeneratePoissonArrival.R")

par(bg = "white")  # Set background to white

NumSub   <- 600
NumPrd   <- 1  
PrdStart <- 0 
AccrRate <- 1 
UserParam <- list( dRate1 = 3, dRate2 = 6, dRate3 = 10, dRate4 = 15, dRate5 = 18, dRate6 = 25, dRate7 = 35 )

lRet <- GeneratePoissonArrival( NumSub, NumPrd, PrdStart, AccrRate, UserParam )


plot( lRet$ArrivalTime , 1:NumSub, type = 'l', xlab = "Time", ylab ="Number of Patients Enrolled", main = "Number of Patients Enrolled Using UserParam")
```




