---
title: 'PK/PD Modeling for Patient Simulation'
author: "Anton Sun"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  word_document: default
  html_document: default
---

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0">These examples are related to the <strong>Integration Point: Response</strong>.
  <a href="IntegrationPointResponse.html" class="alert-link">Click here for more information about this integration point.</a></p>
</div>

# Introduction

The following example demonstrates the capabilities of pharmacokinetic pharmacodynamic (PK/PD) modeling in East Horizon using R integration. We will simulate plasma drug concentrations using a one-compartment model with first-order absorption and elimination, then transform concentration to effect via an Emax model to generate continuous outcomes for a two-arm trial (control vs treatment).

Once CyneRgy is installed, you can load this example in RStudio with the following command:

```{r, eval=FALSE}
CyneRgy::RunExample( "PKPDResponseGeneration" )
```

**RStudio Project File**: [PKPDResponseGeneration.Rproj](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/PKPDResponseGeneration/PKPDResponseGeneration)

In the [R directory of this example](https://github.com/Cytel-Inc/CyneRgy/tree/main/inst/Examples/PKPDResponseGeneration/R) you will find the following R files:

1. [GenerateDrugConcentration.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/PKPDResponseGeneration/R/GenerateDrugConcentration.R) - This file contains the R code for simulating drug concentrations.

2. [PKPDResponseGeneration.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/PKPDResponseGeneration/R/PKPDResponseGeneration.R) - This file contains the R code to simulate treatment effect responses for patients. (Note: Contains *GenerateDrugConcentration.R* function inside)

3. [PlotEmax.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/PKPDResponseGeneration/R/PlotEmax.R) - This file plots a visual that shows the mean response for each treatment group as a function of time.


# Example 1 - Simulate Drug Concentration Response from a One-Compartment Model with First-order Absoprtion

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> 
  This example is related to the R files: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/PKPDResponseGeneration/R/GenerateDrugConcentration.R" class="alert-link">GenerateDrugConcentration.R</a></p>
  <a>
  and 
  <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/PKPDResponseGeneration/R/CreateODE.Temp.R" class="alert-link">
  CreateODE.Temp.R</a></p>
</div>

In the R function *GenerateDrugConcentration*, we use a one-compartment PK model with first-order absorption to generate simulate plasma concentrations for patients. The patient outcome is defined as a list of vectors, the exact quantity of vectors determined by the number of visits defined in the function parameters. Each vector contains the drug concentration for each patient at the given *visitTime*. In addition, an output of either 0 or -1 will also be printed, where the former represents a successful response and latter is a failure.

Refer to the table below for the definitions of the user-defined parameters used in this example.

|**User parameter**|**Definition**|
|----|------|
|**ka**|This is the dose first-order absorption rate constant. It describes the rate at which a drug moves from the site of administration into the central compartment.|
|**ke**|This is the dose first-order elimination rate constant. It describes the fraction of drug eliminated from the body per unit of time once the drug is in the central compartment.|
|**Dose**|This is amount of drug administered to the body at the start of the model.|

The *OneCompartmentModelPK* function is called inside of the main function, and *deSolve* will generate a vector of concentrations that are stored inside the *concentration* variable. Then, depending on whether a patient is assigned to the control or treatment group, a normal distribution with their respective means and standard deviations are added to the concentration vector.

The figure below illustrates where this example fits within the R integration points of Cytel products, accompanied by a flowchart outlining the general steps performed by the R code.

```{r echo=FALSE,  warning=FALSE, fig.retina=3}
CyneRgy::PlotExampleFlowchart(
    lIntPoints = list(
        "Response" = c(
            "Load means, standard deviations, and user parameters", 
            "Generate concentration output using deSolve package", 
            "Generate normal responses for control and treatment groups", 
            "Store patient response data"
        )
    )
)
```

# Example 2 - Simulate Treatment Effect with Emax Model

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> 
  This example is related to the R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/PKPDResponseGeneration/R/PKPDResponseGeneration.R" class="alert-link">PKPDResponseGeneration.R</a></p>
</div>

*PKPDResponseGeneration.R* serves as an extension of *GenerateDrugConcentration.R*. It will convert per-visit plasma concentrations into treatment responses using the Emax PD model. It first calls the PK function to generate drug concentrations per subject per visit, then applies the Emax equation to convert the concentrations to our expected treatment effect: 

$$E = E_0 + \frac{E_{\text{max}} \times C_p}{E_{C_{50}} + C_p}$$

where:

- $E$ is the predicted treatment effect (response) at concentration $C_p$.
- $E_0$ is the baseline effect in the absence of drug (intercept).
- $E_{\text{max}}$ is the maximum incremental effect achievable above baseline.
- $C_p$ is the per-visit plasma concentration for a subject generated by the PK step.
- $E_{C_{50}}$ is the concentration at which 50% of $E_{\text{max}}$ is achieved.

Control group subjects are simulated from normal distributions around control means and std, while treatment subjects receive responses from the Emax-predicted effect with added variability. The output of this function is shown as visit-level response arrays for all subjects, along with an error code of 0 for success, and an error code of -2 if parameter requirements are not met.

Refer to the table below for the definitions of the user-defined parameters used in this example.

|**User parameter**|**Definition**|
|----|------|
|**E0**|This is the baseline effect, when there is an absence of the drug. This can also be interpreted as the intercept in a effect vs concentration graph,|
|**Emax**|This is the maximum drug effect the system can achieve above baseline.|
|**EC50**|This is the drug concentration at which 50% of the maximum effect is achieved.|
|**ka**|This is the dose first-order absorption rate constant. It describes the rate at which a drug moves from the site of administration into the central compartment. *Currently omitted until Q3 release.|
|**ke**|This is the dose first-order elimination rate constant. It describes the fraction of drug eliminated from the body per unit of time once the drug is in the central compartment. *Currently omitted until Q3 release.|
|**Dose**|This is amount of drug administered to the body at the start of the model. *Currently omitted until Q3 release.|

The figure below illustrates where this example fits within the R integration points of Cytel products, accompanied by a flowchart outlining the general steps performed by the R code.

```{r echo=FALSE,  warning=FALSE, fig.retina=3}
CyneRgy::PlotExampleFlowchart(
    lIntPoints = list(
        "Response" = c(
            "Load means, standard deviations, and user parameters", 
            "Calls GenerateDrugConcentration to get concentrations", 
            "Use concentrations as input to calculate TreatmentEffect", 
            "Generate patient responses with treatment data",
            "Store results in response matrix"
        )
    )
)
```

# Example 3 - Integrating externally sourced PK/PD data from a CSV file
