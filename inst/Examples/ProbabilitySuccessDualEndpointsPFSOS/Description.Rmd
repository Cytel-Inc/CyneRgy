---
title: 'Probability of Success for Dual Endpoints (PFS & OS)'
author: "Gabriel Potvin, Valeria A. G. Mazzanti, J. Kyle Wathen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document: default
  word_document: default
---

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0">The following scripts are related to both the <a href="IntegrationPointResponse.html" class="alert-link"><strong>Integration Point: Response</strong></a> and the <a href="IntegrationPointAnalysis.html" class="alert-link"><strong>Integration Point: Analysis</strong></a>. Click on the links for more information about these integration points.</p>
</div>

# Introduction

This example demonstrates how to compute the probability of success of a clinical trial by extending East Horizon’s single-endpoint framework to handle dual endpoints using custom R scripts for the **Response (Patient Simulation)** and the **Analysis** integration points. This example uses Progression Free Survival and Overall Survival as endpoints, however, this could be extended to other types of endpoints by modifying the R code. 

To try out this example, start by creating a new project on East Horizon using the **Two Arm Confirmatory** study objective and the **Time to Event** single endpoint, and then create an input set using the **Explore** task.

The figure below illustrates where this example fits within the R integration points of Cytel products, accompanied by flowcharts outlining the general steps performed by the R code.

```{r echo=FALSE,  warning=FALSE, fig.retina=3}
library(ggplot2)

bigcolxmin = 5
bigcolxmax = bigcolxmin + 3

bigcolxmin2 = 8.5
bigcolxmax2 = bigcolxmin2 + 3

# Define main columns
columns <- data.frame(
  xmin = c(0, 1, 2, 3, 4, bigcolxmin, bigcolxmin2),
  xmax = c(0.5, 1.5, 2.5, 3.5, 4.5, bigcolxmax, bigcolxmax2),
  ymin = rep(3, 7),
  ymax = rep(10, 7),
  label = c("Initialization", "Enrollment", "Randomization", "Dropout", "Treatment\nSelection", "Response", "Analysis"),
  fill = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff"),
  border = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff")
)

unitybox = 0.7
spaceybox = 0.5
ymaxfirstbox = 9.75
yminfirstbox = ymaxfirstbox - unitybox
ymaxsecondbox = yminfirstbox - spaceybox
yminsecondbox = ymaxsecondbox - unitybox*1.5
ymaxthirdbox = yminsecondbox - spaceybox
yminthirdbox = ymaxthirdbox - unitybox*1.5
ymaxfourthbox = yminthirdbox - spaceybox
yminfourthbox = ymaxfourthbox - unitybox*1.5

ymaxfifthbox = yminfourthbox - spaceybox
yminfifthbox = ymaxfifthbox - unitybox

# Define flowchart steps 
flowchart <- data.frame(
  xmin = rep(bigcolxmin + 0.1, 5),
  xmax = rep(bigcolxmax - 0.1, 5),
  ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox, ymaxfifthbox),
  ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox, yminfifthbox),
  label = c("Load prior distribution parameters", 
            "Sample median time to PFS \nand OS from Gamma distribution",
            "Sample probability of death \nbefore PFS from Beta distribution",
            "Simulate PFS and OS \nusing multi-state model", 
            "Return survival times"),
  fill = rep("#cfe2ff", 5)
)

# Define arrows for flowchart 
flowchart_arrows <- data.frame(
  x = rep((bigcolxmin+bigcolxmax)/2, 4),
  xend = rep((bigcolxmin+bigcolxmax)/2, 4),
  y = c(flowchart$ymin[1], flowchart$ymin[2], flowchart$ymin[3], flowchart$ymin[4]),
  yend = c(flowchart$ymax[2], flowchart$ymax[3], flowchart$ymax[4], flowchart$ymax[5])
)

yminfirstbox2 = ymaxfirstbox - unitybox
ymaxsecondbox2 = yminfirstbox2 - spaceybox
yminsecondbox2 = ymaxsecondbox2 - unitybox
ymaxthirdbox2 = yminsecondbox2 - spaceybox
yminthirdbox2 = ymaxthirdbox2 - unitybox
ymaxfourthbox2 = yminthirdbox2 - spaceybox
yminfourthbox2 = ymaxfourthbox2 - unitybox*2

ymaxfifthbox2 = yminfourthbox2 - spaceybox
yminfifthbox2 = ymaxfifthbox2 - unitybox*1.5

# Define flowchart steps 
flowchart2 <- data.frame(
  xmin = rep(bigcolxmin2 + 0.1, 5),
  xmax = rep(bigcolxmax2 - 0.1, 5),
  ymax = c(ymaxfirstbox, ymaxsecondbox2, ymaxthirdbox2, ymaxfourthbox2, ymaxfifthbox2),
  ymin = c(yminfirstbox2, yminsecondbox2, yminthirdbox2, yminfourthbox2, yminfifthbox2),
  label = c("Load OS hazard ratio thresholds", 
            "Analyze PFS using Cox regression",
            "Analyze OS using Cox regression",
            "Make interim or final analysis\ndecisions based on efficacy and\nfutility boundaries", 
            "Return test statistics, hazard ratios,\nand decision outcomes"),
  fill = rep("#cfe2ff", 5)
)

# Define arrows for flowchart 
flowchart_arrows2 <- data.frame(
  x = rep((bigcolxmin2+bigcolxmax2)/2, 4),
  xend = rep((bigcolxmin2+bigcolxmax2)/2, 4),
  y = c(flowchart2$ymin[1], flowchart2$ymin[2], flowchart2$ymin[3], flowchart2$ymin[4]),
  yend = c(flowchart2$ymax[2], flowchart2$ymax[3], flowchart2$ymax[4], flowchart2$ymax[5])
)

# Define the legend elements
legend_data <- data.frame(
  xmin = c(9, 10.5),
  xmax = c(10, 11.5),
  ymin = c(2.5, 2.5),
  ymax = c(2.8, 2.8),
  fill = c("lightgray", "#cfe2ff"),
  label = c("Not Used", "Used")
)

# Create the plot
p <- ggplot() +
  # Add main column sections
  geom_rect(data = columns, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill),
            color = columns$border) + 
  scale_fill_identity() +
  # Add labels for the columns
  geom_text(data = columns, aes(x = (xmin + xmax) / 2, y = ymax + 0.7, label = label), size = 3, angle = 20, vjust = 1) +
  # Add flowchart 
  geom_rect(data = flowchart, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
  geom_text(data = flowchart, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
  # Add arrows between flowchart boxes
  geom_curve(data = flowchart_arrows, aes(x = x, y = y, xend = xend, yend = yend),
             curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
  # Add flowchart 
  geom_rect(data = flowchart2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
  geom_text(data = flowchart2, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
  # Add arrows between flowchart boxes
  geom_curve(data = flowchart_arrows2, aes(x = x, y = y, xend = xend, yend = yend),
             curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
  # Remove grid and axes
  theme_void() + 
  theme(panel.background = element_rect(fill = 'white', colour = 'white')) +
  geom_rect(data = legend_data, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
  geom_text(data = legend_data, aes(x = (xmin + xmax) / 2, y = ymin - 0.1, label = label), size = 2.5, vjust = 1) 

print(p)
```

Once CyneRgy is installed, you can load this example in RStudio with the following commands:
```{r, eval=FALSE}
CyneRgy::RunExample( "ProbabilitySuccessDualEndpointsPFSOS" )
```

Running the command above will load the RStudio project in RStudio. 

**RStudio Project File**: [DualEndpoint.Rproj](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/GeneratePoissonArrival/DualEndpoint.Rproj)

In the [R directory of this example](https://github.com/Cytel-Inc/CyneRgy/tree/main/inst/Examples/ProbabilitySuccessDualEndpointsPFSOS/R) you will find the following R files:

1. [AnalyzePFSAndOS.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/ProbabilitySuccessDualEndpointsPFSOS/R/AnalyzePFSAndOS.R) - This file provides the code used for the Analysis integration point below.

1. [Simulate2EndpointTTEWithMultiState.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/ProbabilitySuccessDualEndpointsPFSOS/R/Simulate2EndpointTTEWithMultiState.E) - This file provides the code used for the Response integration point below.

# Response (Patient Simulation) Integration Point

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This endpoint is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/ProbabilitySuccessDualEndpointsPFSOS/R/Simulate2EndpointTTEWithMultiState.R" class="alert-link">Simulate2EndpointTTEWithMultiState.R</a></p>
</div>

We are using East Horizon’s single-endpoint framework, which we customize to support dual endpoints through the Response Integration Point via our R script linked above. The two endpoints of interest are:

- **Progression-Free Survival (PFS)**: The duration during which a patient lives with a disease without experiencing further progression.
- **Overall Survival (OS)**: The total time elapsed from treatment until death.

We use a multi-state model to simulate event times for each patient in every simulated trial. This model captures the relationship between PFS and OS by generating both outcomes together, rather than independently. Information generated from this simulation will be used later for the [Analysis Integration Point](#analysis-integration-point).

![](ProbabilitySuccessDualEndpointsPFSOS_files/MultiStateDiagram.jpg)

The diagram above illustrates the multistate model for survival analysis, with three states:

1. **State 0**: Initial, no progression.
2. **State 1**: Progression, event occurs that makes the disease progress.
3. **State 2**: Death.

There are also three transitions between states:

1. $\alpha_{01}$: Transition rate from Initial to Progression.
1. $\alpha_{02}$: Transition rate from Initial to Death.
1. $\alpha_{12}$: Transition rate from Progression to Death.

From Meller et al. [1], the probability of progression before death is:

$$ q = \frac{\alpha_{01}}{\alpha_{01} + \alpha_{02}} $$

Where $q = 1 - p$, with $p$ being the probability of Death before Progression.

Using this relationship:

$$ \alpha_{02} = \frac{\alpha_{01} \cdot p}{q} $$

Or equivalently:

$$ \alpha_{01} = \frac{\alpha_{02} \cdot q}{p} $$

Progression-Free Survival (PFS) is treated as the minimum of two competing times:

- $X_1 \sim \text{Exp}(\alpha_{01})$: Time from Initial to Progression.
- $X_2 \sim \text{Exp}(\alpha_{02})$: Time from Initial to Death without Progression.

Using the property of the minimum of two exponential random variables [2]:

$$ Z = \min(X_1, X_2) \sim \text{Exp}(\alpha_{01} + \alpha_{02}) $$

The median of an exponential distribution is given by:

$$ M = \frac{\log(2)}{\alpha_{01} + \alpha_{02}} $$

Substituting $alpha_{01}$ in terms of $alpha_{02}$:

$$ M = \frac{1}{\alpha_{01} + \alpha_{02}} = \frac{1}{\frac{\alpha_{02} \cdot q}{p} + \alpha_{02}} = \frac{1}{\alpha_{02} \cdot \left(\frac{q}{p} + 1\right)} $$

Solving for $alpha_{02}$:

$$ \alpha_{02} = \frac{\log(2)}{M \cdot \left(\frac{q}{p} + 1\right)} $$

Once $alpha_{02}$ is calculated, $alpha_{01}$ can be derived using:

$$ \alpha_{01} = \frac{\alpha_{02} \cdot q}{p} $$

Overall Survival (OS) accounts for both pathways:

1. Directly Initial to Death without Progression:
   - Occurs with probability $p$.
   - Survival time is $OS = X_2$ (time to death without progression).

2. Initial to Progression to Death:
   - Occurs with probability $q$.
   - Survival time is $OS = X_1 + X_3$, where:
     - $X_1 \sim \text{Exp}(\alpha_{01})$ (time to progression),
     - $X_3 \sim \text{Exp}(\alpha_{12})$ (time from progression to death).

The median OS ($M_{OS}$) is approximated as a weighted combination of these two pathways:

$$ M_{OS} = \text{Median}(X_2 \cdot p + (X_1 + X_3) \cdot q) = p \cdot \frac{\log(2)}{\alpha_{02}} + q \cdot (\frac{\log(2)}{\alpha_{01}} + \frac{\log(2)}{\alpha_{12}})$$

To compute $alpha_{12}$, the model numerically solves for the rate using `uniroot`, ensuring consistency with the user-provided median OS.

**Sources**

- [1] Joint Modeling of progression-free and overall survival and computation of correlation measures, Meller M, Beyersmann J, Rufibach K, 2018
- [2] Purdue University, [minimum_two_exponentials.pdf](https://web.archive.org/web/20221223040709/https://llc.stat.purdue.edu/2014/41600/notes/prob3205.pdf)

## Example Using Median Times

We begin by directly inputting the median times and probabilities of death before progression into the script as user parameters. Refer to the table below for the definitions of these user-defined parameters.

|**User parameter**|**Definition**|**Value**|
|---|------|---|
|**dMedianPFS0**|Median time to PFS event for control group|12|
|**dMedianPFS1**|Median time to PFS event for treatment group|18|
|**dMedianOS0**|Median time to OS event for control group|18|
|**dMedianOS1**|Median time to OS event for treatment group|27|
|**dProbOfDeathBeforeProgression0**|Probability of death before PFS for control group|0.2|
|**dProbOfDeathBeforeProgression1**|Probability of death before PFS for treatment group|0.2|

Here, the median times are in months and the hazard ratio for both endpoints (PFS & OS) is equal to $\frac{12}{18} = \frac{18}{27} = 0.6667$. The probability of death before progression is 20% for both control and treatment arms.

## Example Using Prior Distributions

Now we customize how patient data is simulated by building a more realistic model for both PFS and OS outcomes using prior distributions instead of directly using median times and probabilities. Using prior distributions allows us to account for uncertainty around the true treatment effect, which enables users to identify the Probability of Success of a trial rather than statistical Power. Here’s how the event data is generated:

- Time to PFS event is sampled from a Gamma distribution.
- Time to OS event is also sampled from a Gamma distribution.
- The probability that the OS event happens before the PFS event is sampled from a Beta distribution.

All three parameters are treated as random variables, sampled from prior distributions, allowing each simulated trial to reflect a range of possible real-world outcomes.

Refer to the table below for the definitions of the user-defined parameters used in this example.

|**User Parameter**|**Definition**|
|---|------|
|**dMedianPFS0PriorShape**|Shape parameter for the median time to PFS event for control group|
|**dMedianPFS0PriorRate**|Rate parameter for the median time to PFS event for control group|
|**dMedianPFS1PriorShape**|Shape parameter for the median time to PFS event for treatment group|
|**dMedianPFS1PriorRate**|Rate parameter for the median time to PFS event for treatment group|
|**dMedianOS0PriorShape**|Shape parameter for the median time to OS event for control group|
|**dMedianOS0PriorRate**|Rate parameter for the median time to OS event for control group|
|**dMedianOS1PriorShape**|Shape parameter for the median time to OS event for treatment group|
|**dMedianOS1PriorRate**|Rate parameter for the median time to OS event for treatment group|
|**dProbOfDeathBeforeProgression0Param1**|Alpha parameter for probability of death before progression for control group|
|**dProbOfDeathBeforeProgression0Param2**|Beta parameter for probability of death before progression for control group|
|**dProbOfDeathBeforeProgression1Param1**|Alpha parameter for probability of death before progression for treatment group|
|**dProbOfDeathBeforeProgression1Param2**|Beta parameter for probability of death before progression for treatment group|

The shape and rate parameters can be calculated from the assumed mean (i.e. median survival time) and its variance. You can use the following tool to compute these required parameters.

<div class="alert alert-primary" role="alert">
<p style="margin-bottom:0">Enter your desired **mean** and **variance** to calculate the **shape** and **rate** parameters for the Gamma distribution:</p>

<label for="mean">Mean:</label>
<input type="number" id="mean" value="1" step="any"> <br>
<label for="variance">Variance:</label>
<input type="number" id="variance" value="1" step="any"> <br>

<button type="button" class="btn btn-primary" onclick="calculateGammaParams()">Calculate</button> <br>

<p><strong>Shape:</strong> <span id="shapeOut">-</span></p>
<p><strong>Rate:</strong> <span id="rateOut">-</span></p>

<script>
function calculateGammaParams() {
  const mean = parseFloat(document.getElementById("mean").value);
  const variance = parseFloat(document.getElementById("variance").value);

  if (isNaN(mean) || isNaN(variance) || mean <= 0 || variance <= 0) {
    alert("Please enter valid positive numbers for both mean and variance.");
    return;
  }

  const shape = mean * mean / variance;
  const rate = mean / variance;

  document.getElementById("shapeOut").innerText = shape.toFixed(4);
  document.getElementById("rateOut").innerText = rate.toFixed(4);
}
</script>
</div>

If you have the scale parameter for your assumption instead of the rate parameter, you can convert from one to the other using the formula $Rate = \frac{1}{Scale}$.

### Scenario 1: Alternative Hypothesis & Equal Variance

In this first scenario, we want:

- A variance of 10 for both endpoints (PFS and OS) and both arms (control and treatment).
- For the control arm:
    - A mean time to PFS event of 12 months.
    - A mean time to OS event of 18 months.
- For the treatment arm:
    - A mean time to PFS event of 18 months.
    - A mean time to OS event of 27 months.
- A probability of death before progression of 20% for both arms.

Using the tool above, we get:

- For $mean = 12$, $variance = 10$ $\rightarrow$ $shape = 14.4$, $rate = 1.2$
- For $mean = 18$, $variance = 10$ $\rightarrow$ $shape = 32.4$, $rate = 1.8$
- For $mean = 27$, $variance = 10$ $\rightarrow$ $shape = 72.9$, $rate = 2.7$

Refer to the table below for the values of all user-defined parameters used in this example.

|**User parameter**|**Value**|
|---|------|
|**dMedianPFS0PriorShape**|14.4|
|**dMedianPFS0PriorRate**|1.2|
|**dMedianPFS1PriorShape**|32.4|
|**dMedianPFS1PriorRate**|1.8|
|**dMedianOS0PriorShape**|32.4|
|**dMedianOS0PriorRate**|1.8|
|**dMedianOS1PriorShape**|72.9|
|**dMedianOS1PriorRate**|2.7|
|**dProbOfDeathBeforeProgression0Param1**|20|
|**dProbOfDeathBeforeProgression0Param2**|80|
|**dProbOfDeathBeforeProgression1Param1**|20|
|**dProbOfDeathBeforeProgression1Param2**|80|

### Scenario 2: Alternative Hypothesis & Higher Variance

In this second scenario, we want:

- For the control arm:
    - A variance of 10 for both endpoints (PFS and OS).
    - A mean time to PFS event of 12 months.
    - A mean time to OS event of 18 months.
- For the treatment arm:
    - A variance of 20 for both endpoints (PFS and OS).
    - A mean time to PFS event of 18 months.
    - A mean time to OS event of 27 months.
- A probability of death before progression of 20% for both arms.

Using the tool above, we get:

- For $mean = 12$, $variance = 10$ $\rightarrow$ $shape = 14.4$, $rate = 1.2$
- For $mean = 18$, $variance = 10$ $\rightarrow$ $shape = 32.4$, $rate = 1.8$
- For $mean = 18$, $variance = 20$ $\rightarrow$ $shape = 16.2$, $rate = 0.9$
- For $mean = 27$, $variance = 20$ $\rightarrow$ $shape = 36.45$, $rate = 1.35$

Refer to the table below for the values of all user-defined parameters used in this example.

|**User parameter**|**Value**|
|---|------|
|**dMedianPFS0PriorShape**|14.4|
|**dMedianPFS0PriorRate**|1.2|
|**dMedianPFS1PriorShape**|16.2|
|**dMedianPFS1PriorRate**|0.9|
|**dMedianOS0PriorShape**|32.4|
|**dMedianOS0PriorRate**|1.8|
|**dMedianOS1PriorShape**|36.45|
|**dMedianOS1PriorRate**|1.35|
|**dProbOfDeathBeforeProgression0Param1**|20|
|**dProbOfDeathBeforeProgression0Param2**|80|
|**dProbOfDeathBeforeProgression1Param1**|20|
|**dProbOfDeathBeforeProgression1Param2**|80|

### Scenario 3: Null Hypothesis & Equal Variance

In this third scenario, we want:

- A variance of 10 for both endpoints (PFS and OS) and both arms (control and treatment).
- For the control arm:
    - A mean time to PFS event of 12 months.
    - A mean time to OS event of 18 months.
- For the treatment arm:
    - A mean time to PFS event of 12 months.
    - A mean time to OS event of 18 months.
- A probability of death before progression of 20% for both arms.

Using the tool above, we get:

- For $mean = 12$, $variance = 10$ $\rightarrow$ $shape = 14.4$, $rate = 1.2$
- For $mean = 18$, $variance = 10$ $\rightarrow$ $shape = 32.4$, $rate = 1.8$

Refer to the table below for the values of all user-defined parameters used in this example.

|**User parameter**|**Value**|
|---|------|
|**dMedianPFS0PriorShape**|14.4|
|**dMedianPFS0PriorRate**|1.2|
|**dMedianPFS1PriorShape**|14.4|
|**dMedianPFS1PriorRate**|1.2|
|**dMedianOS0PriorShape**|32.4|
|**dMedianOS0PriorRate**|1.8|
|**dMedianOS1PriorShape**|32.4|
|**dMedianOS1PriorRate**|1.8|
|**dProbOfDeathBeforeProgression0Param1**|20|
|**dProbOfDeathBeforeProgression0Param2**|80|
|**dProbOfDeathBeforeProgression1Param1**|20|
|**dProbOfDeathBeforeProgression1Param2**|80|

### Scenario 4: Null Hypothesis & Higher Variance

In this final scenario, we want:

- For the control arm:
    - A variance of 10 for both endpoints (PFS and OS)
    - A mean time to PFS event of 12 months.
    - A mean time to OS event of 18 months.
- For the treatment arm:
    - A variance of 20 for both endpoints (PFS and OS)
    - A mean time to PFS event of 12 months.
    - A mean time to OS event of 18 months.
- A probability of death before progression of 20% for both arms.

Using the tool above, we get:

- For $mean = 12$, $variance = 10$ $\rightarrow$ $shape = 14.4$, $rate = 1.2$
- For $mean = 18$, $variance = 10$ $\rightarrow$ $shape = 32.4$, $rate = 1.8$
- For $mean = 12$, $variance = 20$ $\rightarrow$ $shape = 7.2$, $rate = 0.6$
- For $mean = 18$, $variance = 20$ $\rightarrow$ $shape = 16.2$, $rate = 0.9$

Refer to the table below for the values of all user-defined parameters used in this example.

|**User parameter**|**Value**|
|---|------|
|**dMedianPFS0PriorShape**|14.4|
|**dMedianPFS0PriorRate**|1.2|
|**dMedianPFS1PriorShape**|7.2|
|**dMedianPFS1PriorRate**|0.6|
|**dMedianOS0PriorShape**|32.4|
|**dMedianOS0PriorRate**|1.8|
|**dMedianOS1PriorShape**|16.2|
|**dMedianOS1PriorRate**|0.9|
|**dProbOfDeathBeforeProgression0Param1**|20|
|**dProbOfDeathBeforeProgression0Param2**|80|
|**dProbOfDeathBeforeProgression1Param1**|20|
|**dProbOfDeathBeforeProgression1Param2**|80|

# Analysis Integration Point

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0"> This endpoint is related to this R file: <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/ProbabilitySuccessDualEndpointsPFSOS/R/AnalyzePFSAndOS.R" class="alert-link">AnalyzePFSAndOS.R</a></p>
</div>

Using the file above, the Analysis element of East Horizon's simulation is customized to compute the probability of success (PoS) for the trial, based on dual endpoints: Progression-Free Survival (PFS) and Overall Survival (OS). The file uses information from the simulation (*SimData* variable) that is generated by the Response element of East Horizon's simulation. See the [Response section](#response-patient-simulation-integration-point) above for more information about the PFS and OS endpoints generation.

The criteria for declaring trial success are as follows. Both criteria must be met to declare success:

- **PFS Endpoint**: Statistical significance must be achieved by crossing the predefined efficacy boundary (defined by East Horizon, using a frequentist analysis).
- **OS Endpoint**: A positive trend must be observed, defined as the OS hazard ratio being below a pre-specified threshold (defined with user parameters).

**Note:** At an interim analysis, we usually set stricter criteria for a positive trend on OS compared to the final analysis. This is because we have less data early on, so we want to be more confident in any decision we make at that stage. Therefore, the threshold defining a positive trend at the interim is typically lower than the threshold used at the final analysis. 

Refer to the table below for the definitions of the user-defined parameters used in this example.

|**User parameter**|**Definition**|
|---|------|
|**HazardRatioCutoffIA**|OS hazard ratio threshold used for the interim analysis|
|**HazardRatioCutoffFA**|OS hazard ratio threshold used for the final analysis|

## Option 1: Fixed Sample Design

The first option is a fixed sample design with a hazard ratio threshold of 0.9. This option shows that we can still use this script without interim analyses. Refer to the table below for the values of the user-defined parameters used in this option.

|**User parameter**|**Value**|
|---|------|
|**HazardRatioCutoffFA**|0.9|

## Option 2: Group Sequential Design

The second option is a group sequential design with hazard ratio thresholds of 0.8 (for interim analysis) and 0.9 (for final analysis). Refer to the table below for the values of the user-defined parameters used in this option.

|**User parameter**|**Value**|
|---|------|
|**HazardRatioCutoffIA**|0.8|
|**HazardRatioCutoffFA**|0.9|

## Option 3: Low PoS Group Sequential Design

The third option is a group sequential design with a lower hazard ratio threshold of 0.5 for both interim and final analyses. Refer to the table below for the values of the user-defined parameters used in this option.

|**User parameter**|**Value**|
|---|------|
|**HazardRatioCutoffIA**|0.5|
|**HazardRatioCutoffIA**|0.5|

## Option 4: High PoS Group Sequential Design

The fourth option is a group sequential design with a lower hazard ratio threshold of 0.5 (for interim analysis) and a higher hazard ratio threshold of 1.2 (for final analysis). Refer to the table below for the values of the user-defined parameters used in this option.

|**User parameter**|**Value**|
|---|------|
|**HazardRatioCutoffIA**|0.5|
|**HazardRatioCutoffIA**|1.2|

# Conclusion

In the Results section, *Power* now refers to the probability of success, where success is defined as a statistically significant difference in time to progression-free survival (PFS) between the control and treatment arm as well as a positive trend in overall survival (OS), i.e. the time to overall survival (OS) is longer in magnitude for the patients in the treatment arm compared to those in the control arm. Below is an example of the heatmap that could be generated by East Horizon following the simulation. Each square represents the simulated probability of success for a trial, based on a specific combination of Response scenario (columns) and Analysis option (rows).

![](ProbabilitySuccessDualEndpointsPFSOS_files/Results-heatmap.png)
