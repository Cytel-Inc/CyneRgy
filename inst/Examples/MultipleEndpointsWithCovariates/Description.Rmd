---
title: 'Multiple Endpoints With Covariates and Stratified Randomization'
author: "Julija Saltane"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 5
    number_sections: true
    latex_engine: tinytex
  word_document: default
  pdf_document:
    toc: true
    toc_depth: '5'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library( CyneRgy )
```

# Introduction
The following examples illustrate how to incorporate new patient outcome simulation (*response*) and analysis (*design*) capabilities into East Horizon using R functions in the context of a two-arm trial. Each example features a trial design consisting of a standard-of-care control arm and an experimental treatment arm, with three independent patient outcomes modeled as continuous data.
Two of the examples include two binary covariates, and one of these also applies stratified randomization based on the covariates. All designs include a single final analysis. In the example without covariates, the response data is analyzed using a t-test. In contrast, the other two examples employ ANCOVA to account for covariate effects.

Once CyneRgy is installed, you can load this example in RStudio with the following command:
```{r, eval=FALSE}
CyneRgy::RunExample( "MultipleEndpointsWithCovariates" )
```

This will open the corresponding RStudio project.

**RStudio Project File**: [MultipleEndpointsWithCovariates.Rproj](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/MultipleEndpointsWithCovariates.Rproj)

In the [R directory of this example](https://github.com/Cytel-Inc/CyneRgy/tree/main/inst/Examples/MultipleEndpointsWithCovariates/R), you will find the following R files:

1. [SimulateMultipleOutcomes.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/SimulateMultipleOutcomes.R) 
Provides an example R function to simulate three independent normally distributed outcomes for a given number of subject. Note that example can be extended to any number of endpoints.

1. [SimulateMultipleOutcomesCovariates.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/SimulateMultipleOutcomesCovariates.R)
This R function simulates three independent normally distributed outcomes with two binary covariates. This function is extensible to any number of endpoints and covariates.

1. [SimulateMultipleOutcomesCovariatesStratRandomization.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/SimulateMultipleOutcomesCovariatesStratRandomization.R)
Similar to the previous function, this version explicitly incorporates stratified randomization based on two binary covariates.

1. [AnalyzeMultipleOutcomes.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/AnalyzeMultipleOutcomes.R)
This files provides an example R function to perform endpoint-wise one-sided t-tests on simulated patient data with three normally distributed outcomes.

1. [AnalyzeMultipleOutcomesCovariates.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/AnalyzeMultipleOutcomesCovariates.R) - This files provides and example R function to perform statistical analysis on simulated patient-level data with three continuous endpoints and binary covariates. For each endpoint, an ANCOVA model is fitted to assess the treatment effect while adjusting for covariates.

1. [AnalyzeMultipleOutcomesCovariatesStratRandomization.R](https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/SimulateMultipleOutcomesCovariatesStratRandomization.R)
Extends the previous analysis to include stratified randomization. Each endpoint is analyzed using ANCOVA, adjusting for covariates.

## Example 1 - Simulate and Analyze Multiple Endpoint Data 

<div class="alert alert-primary" role="alert">
    <p style="margin-bottom:0"> 
        This example is related to the following R files: 
        <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/SimulateMultipleOutcomes.R"         class="alert-link">SimulateMultipleOutcomes.R</a>
        and 
        <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/AnalyzeMultipleOutcomes.R" class="alert-link">SimulateMultipleOutcomes.R</a>.  
    </p>
</div>

In this example, patient outcomes are modeled as independent, continuous variables generated from a normal distribution. Each outcome has a treatment-specific mean, while the standard deviation is assumed to be the same across all outcomes.

The table below defines the user-specified parameters used to simulate patient data:

|**User parameter**|**Definition**|
|----|------|
|**MeanOutcome[X]Ctrl**|Mean of outcome X for the control arm, where X = 1, 2 or 3|
|**MeanOutcome[X]Trt**|Mean of outcome X for the experimental arm, where X = 1, 2 or 3|

The simulated data is analyzed using a one-sided t-test to compare the treatment and control groups, assuming equal variances. No additional user-defined parameters are required for the analysis in this example.

The figure below illustrates where this example fits within the R integration points of East Horizon, along with a flowchart outlining the key steps performed by the R code.

```{r echo=FALSE,  warning=FALSE}
library(ggplot2)

# creating big boxes for each of 7 stages of clinical trial simulation setup:
width = 3
spacexbox = 0.5

bigcolxmin = 5
bigcolxmax = bigcolxmin + width
bigcolxmin_2 = bigcolxmax + spacexbox
bigcolxmax_2 = bigcolxmin_2 + width


# Define main columns
columns <- data.frame(
    xmin = c(0, 1, 2, 3, 4, bigcolxmin, bigcolxmin_2),
    xmax = c(0.5, 1.5, 2.5, 3.5, 4.5, bigcolxmax, bigcolxmax_2),
    ymin = rep(3.5, 7),
    ymax = rep(10, 7),
    label = c("Initialization", "Enrollment", "Randomization", "Dropout", "Treatment\nSelection", "Response", "Analysis"),
    fill = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff"),
    border = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff")
)

unitybox = 0.7
spaceybox = 0.5
ymaxfirstbox = 9.4
yminfirstbox = ymaxfirstbox - unitybox*2
ymaxsecondbox = yminfirstbox - spaceybox
yminsecondbox = ymaxsecondbox - unitybox
ymaxthirdbox = yminsecondbox - spaceybox
yminthirdbox = ymaxthirdbox - unitybox*1.5
ymaxfourthbox = yminthirdbox - spaceybox
yminfourthbox = ymaxfourthbox - unitybox


# Define flowchart steps inside "Response"
flowchart <- data.frame(
    xmin = rep(5.3, 4),
    xmax = rep(7.7, 4),
    ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox),
    ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox),
    label = c("Load means of outcomes for control \n and  experimental arm: \n MeanOutcome1Ctrl, MeanOutcome1Trt, \n MeanOutcome2Ctrl, MeanOutcome2Trt, \n MeanOutcome3Ctrl, MeanOutcome3Trt", 
              "Loop through patients", 
              "Simulate each outcome using \n normal distribution", 
              "Return responses as \n PatientOutcome1, PatientOutcome2, \n PatientOutcome3"),
    fill = rep("#cfe2ff", 4)
)

# Define arrows for flowchart inside "Response"
flowchart_arrows <- data.frame(
    x = rep((bigcolxmin+bigcolxmax)/2, 3),
    xend = rep((bigcolxmin+bigcolxmax)/2, 3),
    y = c(flowchart$ymin[1], flowchart$ymin[2], flowchart$ymin[3]),
    yend = c(flowchart$ymax[2], flowchart$ymax[3], flowchart$ymax[4])
)

####

# Define flowchart steps inside "Analysis"
flowchart_2  <- data.frame(
    xmin = rep(8.8, 4),
    xmax = rep(11.2, 4),
    ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox),
    ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox),
    label = c("Load responses from East Horizon \n including: \n PatientOutcome1, PatientOutcome2, \n PatientOutcome3", 
              "Run t-test (treatment > control)", 
              "Extract p-value", 
              "Return decision and p-value for each \n outcome per arm"),
    fill = rep("#cfe2ff", 4)
)

# Define arrows for flowchart_2 inside "Analysis"
flowchart_2_arrows <- data.frame(
    x = rep((bigcolxmin_2+bigcolxmax_2)/2, 3),
    xend = rep((bigcolxmin_2+bigcolxmax_2)/2, 3),
    y = c(flowchart_2$ymin[1], flowchart_2$ymin[2], flowchart_2$ymin[3]),
    yend = c(flowchart_2$ymax[2], flowchart_2$ymax[3], flowchart_2$ymax[4])
)

# Define the legend elements
legend_data <- data.frame(
    xmin = c(6.8, 8),
    xmax = c(7.8, 9),
    ymin = c(3, 3),
    ymax = c(3.3, 3.3),
    fill = c("lightgray", "#cfe2ff"),
    label = c("Not Used", "Used")
)

# Create the plot
p <- ggplot() +
    # Add main column sections
    geom_rect(data = columns, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill),
              color = columns$border) + 
    scale_fill_identity() +
    # Add labels for the columns
    geom_text(data = columns, aes(x = (xmin + xmax) / 2, y = ymax + 0.7, label = label), size = 3, angle = 0, vjust = 1) +
    # Add flowchart inside "Response"
    geom_rect(data = flowchart, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = flowchart, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
    # Add arrows between flowchart boxes
    geom_curve(data = flowchart_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
    # ANALYSIS:
    geom_rect(data = flowchart_2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = flowchart_2, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
    geom_curve(data = flowchart_2_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
    # Remove grid and axes
    theme_void() + 
    theme(panel.background = element_rect(fill = 'white', colour = 'white')) +
    geom_rect(data = legend_data, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = legend_data, aes(x = (xmin + xmax) / 2, y = ymin - 0.1, label = label), size = 2.5, vjust = 1) 

print(p)

```

## Example 2 - Simulate and Analyze Multiple Endpoint Data with Two Binary Covariates

<div class="alert alert-primary" role="alert">
    <p style="margin-bottom:0"> 
        This example is related to these R files: 
        <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/SimulateMultipleOutcomesCovariates.R"         class="alert-link">SimulateMultipleOutcomes.R</a>
        and 
        <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/AnalyzeMultipleOutcomesCovariates.R" class="alert-link">SimulateMultipleOutcomes.R</a>.  
    </p>
</div>

Just like in Example 1, patient outcomes are modeled as independent, continuous variables generated from a normal distribution. Additionally, two binary covariates are included, each with user-specified probabilities and effect sizes.

The table below outlines the user-specified parameters used to simulate patient data:

|**User parameter**|**Definition**|
|----|------|
|**MeanOutcome[X]Ctrl**|Mean of outcome X for the control arm, where X = 1, 2 or 3|
|**MeanOutcome[X]Trt**|Mean of outcome X for the experimental arm, where X = 1, 2 or 3|
|**Beta[Y]**|Effect size of binary covariate Y, where = 1 or 2|
|**Cov[Y]Prob**|Probability that covariate Y takes value 1, where = 1 or 2|

The simulated data is analyzed ANCOVA model to estimate the treatment effect while adjusting for covariates. No additional user-defined parameters are required for the analysis in this example.

The figure below shows how this example integrates with the R components of East Horizon, along with a flowchart summarizing the key steps executed by the R code.

```{r echo=FALSE,  warning=FALSE}
library(ggplot2)

# creating big boxes for each of 7 stages of clinical trial simulation setup:
width = 3
spacexbox = 0.5

bigcolxmin = 5
bigcolxmax = bigcolxmin + width
bigcolxmin_2 = bigcolxmax + spacexbox
bigcolxmax_2 = bigcolxmin_2 + width


# Define main columns
columns <- data.frame(
    xmin = c(0, 1, 2, 3, 4, bigcolxmin, bigcolxmin_2),
    xmax = c(0.5, 1.5, 2.5, 3.5, 4.5, bigcolxmax, bigcolxmax_2),
    ymin = rep(3.5, 7),
    ymax = rep(10, 7),
    label = c("Initialization", "Enrollment", "Randomization", "Dropout", "Treatment\nSelection", "Response", "Analysis"),
    fill = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff"),
    border = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff")
)


unitybox = 0.7
spaceybox = 0.4
ymaxfirstbox = 9.4
yminfirstbox = ymaxfirstbox - unitybox*2

ymaxsecondbox = yminfirstbox - spaceybox
yminsecondbox = ymaxsecondbox - unitybox*0.7

ymaxthirdbox = yminsecondbox - spaceybox
yminthirdbox = ymaxthirdbox - unitybox*0.7

ymaxfourthbox = yminthirdbox - spaceybox
yminfourthbox = ymaxfourthbox - unitybox*0.7

ymaxfifthbox = yminfourthbox - spaceybox
yminfifthbox = ymaxfifthbox - unitybox*1.3


# Define flowchart steps inside "Response"
flowchart <- data.frame(
    xmin = rep(5.3, 5),
    xmax = rep(7.7, 5),
    ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox, ymaxfifthbox),
    ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox, yminfifthbox),
    label = c("Load means of outcomes for control \n and  experimental arm: \n MeanOutcome1Ctrl, MeanOutcome1Trt, \n MeanOutcome2Ctrl, MeanOutcome2Trt, \n MeanOutcome3Ctrl, MeanOutcome3Trt \n and parameters for covariates: \n Beta1, Beta2, Cov1Prob, Cov2Prob ", 
              "Simulate effect of covariates using \n binomial distribution", 
              "Loop through patients",
              "Simulate each outcome using \n normal distribution", 
              "Return responses as \n PatientOutcome1, PatientOutcome2, \n PatientOutcome3, \n Covariate1, Covariate2"),
    fill = rep("#cfe2ff", 5)
)

# Define arrows for flowchart inside "Response"
flowchart_arrows <- data.frame(
    x = rep((bigcolxmin+bigcolxmax)/2, 4),
    xend = rep((bigcolxmin+bigcolxmax)/2, 4),
    y = c(flowchart$ymin[1], flowchart$ymin[2], flowchart$ymin[3], flowchart$ymin[4]),
    yend = c(flowchart$ymax[2], flowchart$ymax[3], flowchart$ymax[4], flowchart$ymax[5])
)

####
unitybox = 0.7
spaceybox = 0.5
ymaxfirstbox = 9.4
yminfirstbox = ymaxfirstbox - unitybox*2
ymaxsecondbox = yminfirstbox - spaceybox
yminsecondbox = ymaxsecondbox - unitybox
ymaxthirdbox = yminsecondbox - spaceybox
yminthirdbox = ymaxthirdbox - unitybox*1.5
ymaxfourthbox = yminthirdbox - spaceybox
yminfourthbox = ymaxfourthbox - unitybox

# Define flowchart steps inside "Analysis"
flowchart_2  <- data.frame(
    xmin = rep(8.8, 4),
    xmax = rep(11.2, 4),
    ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox),
    ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox),
    label = c("Load responses from East Horizon \n including: \n PatientOutcome1, PatientOutcome2, \n PatientOutcome3,\n Covariate1, Covariate2 ", 
              "Run ANCOVA", 
              "Extract p-values", 
              "Return decision and p-value for each \n outcome per arm and covariate"),
    fill = rep("#cfe2ff", 4)
)

# Define arrows for flowchart_2 inside "Analysis"
flowchart_2_arrows <- data.frame(
    x = rep((bigcolxmin_2+bigcolxmax_2)/2, 3),
    xend = rep((bigcolxmin_2+bigcolxmax_2)/2, 3),
    y = c(flowchart_2$ymin[1], flowchart_2$ymin[2], flowchart_2$ymin[3]),
    yend = c(flowchart_2$ymax[2], flowchart_2$ymax[3], flowchart_2$ymax[4])
)

# Define the legend elements
legend_data <- data.frame(
    xmin = c(6.8, 8),
    xmax = c(7.8, 9),
    ymin = c(3, 3),
    ymax = c(3.3, 3.3),
    fill = c("lightgray", "#cfe2ff"),
    label = c("Not Used", "Used")
)

# Create the plot
p <- ggplot() +
    # Add main column sections
    geom_rect(data = columns, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill),
              color = columns$border) + 
    scale_fill_identity() +
    # Add labels for the columns
    geom_text(data = columns, aes(x = (xmin + xmax) / 2, y = ymax + 0.7, label = label), size = 3, angle = 0, vjust = 1) +
    # Add flowchart inside "Response"
    geom_rect(data = flowchart, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = flowchart, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
    # Add arrows between flowchart boxes
    geom_curve(data = flowchart_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
    # ANALYSIS:
    geom_rect(data = flowchart_2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = flowchart_2, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
    geom_curve(data = flowchart_2_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
    # Remove grid and axes
    theme_void() + 
    theme(panel.background = element_rect(fill = 'white', colour = 'white')) +
    geom_rect(data = legend_data, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = legend_data, aes(x = (xmin + xmax) / 2, y = ymin - 0.1, label = label), size = 2.5, vjust = 1) 

print(p)
```

## Example 3 - Simulate and Analyze Multiple Endpoint Data with Two Binary Covariates and Stratified Randomization

<div class="alert alert-primary" role="alert">
    <p style="margin-bottom:0"> 
        This example is related to these R files: 
        <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/SimulateMultipleOutcomesCovariatesStratRandomization.R"         class="alert-link">SimulateMultipleOutcomes.R</a>
        and 
        <a href="https://github.com/Cytel-Inc/CyneRgy/blob/main/inst/Examples/MultipleEndpointsWithCovariates/R/AnalyzeMultipleOutcomesCovariatesStratRandomization.R" class="alert-link">SimulateMultipleOutcomes.R</a>.  
    </p>
</div>

Example 3 introduces stratified randomization, replacing East Horizon’s native patient allocation feature. As in Examples 1 and 2, patient outcomes are modeled as independent, continuous variables from a normal distribution. Two binary covariates are again included, with their probabilities and effect sizes specified as in Example 2. Stratified randomization is performed based on these covariates.

The table below defines the user-specified parameters used to simulate patient data:

|**User parameter**|**Definition**|
|----|------|
|**MeanOutcome[X]Ctrl**|Mean of outcome X for the control arm, where X = 1, 2 or 3|
|**MeanOutcome[X]Trt**|Mean of outcome X for the experimental arm, where X = 1, 2 or 3|
|**Beta[Y]**|Effect size of binary covariate Y, where = 1 or 2|
|**Cov[Y]Prob**|Probability that covariate Y takes the value 1, where = 1 or 2|
|**AllocRatio**| Ratio of treatment to control allocation |

As before, the simulated data is analyzed using an ANCOVA model to assess the treatment effect while adjusting for covariates. In this example, the treatment assignments generated during the response simulation are directly used in the analysis. No additional user-defined parameters are needed for the analysis.

The figure below illustrates how this example fits into the R integration points of East Horizon, accompanied by a flowchart detailing the main steps performed by the R code.

```{r}
library(ggplot2)

# creating big boxes for each of 7 stages of clinical trial simulation setup:
width = 3
spacexbox = 0.5

bigcolxmin = 5
bigcolxmax = bigcolxmin + width
bigcolxmin_2 = bigcolxmax + spacexbox
bigcolxmax_2 = bigcolxmin_2 + width


# Define main columns
columns <- data.frame(
    xmin = c(0, 1, 2, 3, 4, bigcolxmin, bigcolxmin_2),
    xmax = c(0.5, 1.5, 2.5, 3.5, 4.5, bigcolxmax, bigcolxmax_2),
    ymin = rep(3.5, 7),
    ymax = rep(10, 7),
    label = c("Initialization", "Enrollment", "Randomization", "Dropout", "Treatment\nSelection", "Response", "Analysis"),
    fill = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff"),
    border = c("lightgray", "lightgray", "lightgray", "lightgray", "lightgray", "#cfe2ff", "#cfe2ff")
)


unitybox = 0.7
spaceybox = 0.3
ymaxfirstbox = 9.6
yminfirstbox = ymaxfirstbox - unitybox*2.1

ymaxsecondbox = yminfirstbox - spaceybox
yminsecondbox = ymaxsecondbox - unitybox*0.7

ymaxthirdbox = yminsecondbox - spaceybox
yminthirdbox = ymaxthirdbox - unitybox*0.7

ymaxfourthbox = yminthirdbox - spaceybox
yminfourthbox = ymaxfourthbox - unitybox*0.7

ymaxfifthbox = yminfourthbox - spaceybox
yminfifthbox = ymaxfifthbox - unitybox*0.7

ymaxsixthbox = yminfifthbox - spaceybox
yminsixthbox = ymaxsixthbox - unitybox*1.4

# Define flowchart steps inside "Response"
flowchart <- data.frame(
    xmin = rep(5.3, 6),
    xmax = rep(7.7, 6),
    ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox, ymaxfifthbox, ymaxsixthbox),
    ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox, yminfifthbox, yminsixthbox),
    label = c("Load means of outcomes for control \n and  experimental arm: \n MeanOutcome1Ctrl, MeanOutcome1Trt, \n MeanOutcome2Ctrl, MeanOutcome2Trt, \n MeanOutcome3Ctrl, MeanOutcome3Trt \n and parameters for covariates:\n Beta1, Beta2, Cov1Prob, Cov2Prob, \n AllocRatio ", 
              "Simulate effect of covariates using \n binomial distribution", 
              "Create strata & randomize patients \n within each stratum",
              "Loop through patients", 
              "Simulate each outcome using \n normal distribution", 
              "Return responses as \n PatientOutcome1, PatientOutcome2, \n PatientOutcome3, \n Covariate1, Covariate2, \n PatientTreatmentID"),
    fill = rep("#cfe2ff", 6)
)

# Define arrows for flowchart inside "Response"
arrow_shorten_factor <- 0.9  # 90% of original leng

flowchart_arrows <- data.frame(
    x = rep((bigcolxmin+bigcolxmax)/2, 5),
    xend = rep((bigcolxmin+bigcolxmax)/2, 5),
    y = c(flowchart$ymin[1], flowchart$ymin[2], flowchart$ymin[3], flowchart$ymin[4], flowchart$ymin[5]),
    yend = c(flowchart$ymax[2], flowchart$ymax[3], flowchart$ymax[4], flowchart$ymax[5], flowchart$ymax[6])
)

####

# Define flowchart steps inside "Analysis"
unitybox = 0.7
spaceybox = 0.5
ymaxfirstbox = 9.6
yminfirstbox = ymaxfirstbox - unitybox*2.1
ymaxsecondbox = yminfirstbox - spaceybox
yminsecondbox = ymaxsecondbox - unitybox*1.3
ymaxthirdbox = yminsecondbox - spaceybox
yminthirdbox = ymaxthirdbox - unitybox*1.3
ymaxfourthbox = yminthirdbox - spaceybox
yminfourthbox = ymaxfourthbox - unitybox*1.6

flowchart_2  <- data.frame(
    xmin = rep(8.8, 4),
    xmax = rep(11.2, 4),
    ymax = c(ymaxfirstbox, ymaxsecondbox, ymaxthirdbox, ymaxfourthbox),
    ymin = c(yminfirstbox, yminsecondbox, yminthirdbox, yminfourthbox),
    label = c("Load responses from East Horizon \n including: \n PatientOutcome1, PatientOutcome2, \n PatientOutcome3,\n Covariate1, Covariate2, \nPatientTreatmentID ", 
              "Run ANCOVA", 
              "Extract p-values", 
              "Return decision and p-value for each \n outcome per arm and covariate"),
    fill = rep("#cfe2ff", 4)
)

# Define arrows for flowchart_2 inside "Analysis"
flowchart_2_arrows <- data.frame(
    x = rep((bigcolxmin_2+bigcolxmax_2)/2, 3),
    xend = rep((bigcolxmin_2+bigcolxmax_2)/2, 3),
    y = c(flowchart_2$ymin[1], flowchart_2$ymin[2], flowchart_2$ymin[3]),
    yend = c(flowchart_2$ymax[2], flowchart_2$ymax[3], flowchart_2$ymax[4])
)

# Define the legend elements
legend_data <- data.frame(
    xmin = c(6.8, 8),
    xmax = c(7.8, 9),
    ymin = c(3, 3),
    ymax = c(3.3, 3.3),
    fill = c("lightgray", "#cfe2ff"),
    label = c("Not Used", "Used")
)

# Create the plot
p <- ggplot() +
    # Add main column sections
    geom_rect(data = columns, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill),
              color = columns$border) + 
    scale_fill_identity() +
    # Add labels for the columns
    geom_text(data = columns, aes(x = (xmin + xmax) / 2, y = ymax + 0.7, label = label), size = 3, angle = 0, vjust = 1) +
    # Add flowchart inside "Response"
    geom_rect(data = flowchart, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = flowchart, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
    # Add arrows between flowchart boxes
    geom_curve(data = flowchart_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
    # ANALYSIS:
    geom_rect(data = flowchart_2, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = flowchart_2, aes(x = (xmin + xmax) / 2, y = (ymin + ymax) / 2, label = label), size = 2.5) +
    geom_curve(data = flowchart_2_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               curvature = 0, arrow = arrow(length = unit(0.15, "cm")), color = "black") +
    # Remove grid and axes
    theme_void() + 
    theme(panel.background = element_rect(fill = 'white', colour = 'white')) +
    geom_rect(data = legend_data, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill), color = "black") +
    geom_text(data = legend_data, aes(x = (xmin + xmax) / 2, y = ymin - 0.1, label = label), size = 2.5, vjust = 1) 

print(p)
```
