---
title: 'MMRM Analysis'
author: "Jacob Wathen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 5
    number_sections: true
    latex_engine: tinytex
  word_document: default
  pdf_document:
    toc: true
    toc_depth: '5'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library( CyneRgy )
```

# Abstract

This document summarizes the goals, background, methods, simulations, results, and takeaways from the CyneRgy MMRM R development work and companion East Horizon simulations completed. It distills the content of the project into a concise narrative.

> **Scope note.** This write‑up focuses on Mixed Models for Repeated Measures (MMRM) analyses for continuous outcomes over time in schizophrenia trials using PANSS as a primary endpoint, plus comparable simulations performed in East Horizon.
 

# Introduction

- This example will cover the setup required to be customized to match an expected clinical trial of lumateperone tosylate on  Schizophrenia.

Our primary outcome in this clinical trial is a change from baseline to follow-up in the Positive and Negative Syndrome Scale (PANNS), it assess schizophrenia on 3 criteria across 30 items. These criteria are positive symptoms (7 items), negative symptoms (7 items), and general psychopathology (16 items). Each of these is rated on a 7-point scale (1 = absent, 7 = extreme). The lower values representing less symptoms of schizophrenia the range being from 30 to 210. The difference from baseline to follow-up must be a change in 6 points to show efficacy after 28 days of treatment. During this 28-day period each individual was measured again after each week.

# Required Files

Before running anything in East Horizon, load the Schizophrenia example by installing CyneRgy and running this command into RStudio:

```{r, eval=FALSE}
CyneRgy::RunExample( "Schizophreniatrial" )
```

Running this code above will load the RStudio project.

**RStudio Project File:** SchizophreniaTrial.Rproj

This project has the required R code files needed to simulate, analyze, plot, and run patient data. Below in the R code folder, there should be the following files:

[AnalyzeMMRM.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/AnalyzeMMRM.R) - This code takes simulated patient data and run analysis.

[AnalyzeMMRM_GLS.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/AnalyzeMMRM_GLS.R) - This code is a slower version of the original analysis, but it has slightly increased power and an alternative form of analysis.

[GenerateMMRMResponses.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/GenerateMMRMResponses.R) - This code generates the responses for patients across treatment visits.

[PlotPatientData.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/PlotPatientData.R) - This code takes the generated patient data and can plot individual patient trajectories.

[PlotTrialdata.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/PlotTrialData.R) - This code takes the overall data generated and creates a plot of the difference of means with a 95% CI.

[RunSimulation.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/RunSimulation.R) - This code allows for the code to be run locally, change variables around, and visualize data.

This example looks into primarily the analysis behind MMRM. It allows for dropout information to not affect power as much has other analysis methods. It works well in East Horizon for providing a longitudinal analysis design.


## Example outputs 

Below are some graphs as example outputs from the code:

**Figure 1**: An example plot of the trial data with a 95% CI

![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Screenshot 2025-08-15 102051.png){width=90%}

**Figure 2**: An example plot of individual patient trajectories

![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Screenshot 2025-08-15 102253.png){width=90%}

# Flowchart of Clinical Trial Process

The flowchart below shows the points of R integration in Cytel products, and it outlines the steps performed by the R code.


```{r flowchart_response_box_wider, fig.width=10, fig.height=6, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(grid)

# ----------------------------
# Layout controls
# ----------------------------
ymin_band  <- 2
ymax_band  <- 10
wrap_width <- 32
wrap_resp  <- 34   # allow wider wrapping for Response
gutter_w   <- 0.08

# ----------------------------
# Columns
# ----------------------------
columns <- data.frame(
  xmin   = c(0, 1, 2, 3, 4, 5, 6),
  xmax   = c(1, 2, 3, 4, 5, 6.75, 8.5),  # Response widened (5→6.75)
  ymin   = ymin_band,
  ymax   = ymax_band,
  label  = c("Initialization","Enrollment","Randomization","Dropout",
             "Treatment\nSelection","Response","Analysis"),
  used   = c(FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE)
)
columns$fill   <- ifelse(columns$used, "#cfe2ff", "lightgray")
columns$border <- columns$fill

# Gutters (keep uniform spacing)
gutters_x <- c(1, 2, 3, 4, 5, 6.75, 8.5)
gutters <- data.frame(
  xmin = gutters_x - gutter_w/2,
  xmax = gutters_x + gutter_w/2,
  ymin = ymin_band,
  ymax = ymax_band
)

# ----------------------------
# Response box (wider)
# ----------------------------
resp_xmin <- 5.1
resp_xmax <- 6.65   # widened width
resp_ymin <- 6.0
resp_ymax <- 8.5

wrap_text <- function(s, width) paste(strwrap(s, width = width), collapse = "\n")
resp_label <- wrap_text(
  "Generates the responses of each patient at each time point (visit), depending on the patient’s treatment",
  width = wrap_resp
)

resp_steps <- data.frame(
  xmin  = resp_xmin,
  xmax  = resp_xmax,
  ymin  = resp_ymin,
  ymax  = resp_ymax,
  label = resp_label
)

# ----------------------------
# Analysis boxes (4 boxes)
# ----------------------------
a_xmin <- 6.9
a_xmax <- 8.35

labels_raw <- c(
  "Takes the generated data and runs analysis",
  "Extracts treatment effect",
  "Uses the rpact package to find the alpha so it can be compared to in step 5 for decision rules",
  "Returns the decision, p-value, error code, and prime delta"
)
labels_wrapped <- vapply(labels_raw, wrap_text, character(1), width = wrap_width)

n_boxes <- 4
top_y   <- 9.5
bot_y   <- 2.5
gap     <- 0.22
box_h   <- (top_y - bot_y - gap*(n_boxes-1)) / n_boxes

steps <- data.frame(
  xmin  = a_xmin,
  xmax  = a_xmax,
  ymin  = seq(from = top_y - box_h, by = -(box_h + gap), length.out = n_boxes),
  ymax  = seq(from = top_y,         by = -(box_h + gap), length.out = n_boxes),
  label = labels_wrapped
)

# Outside arrows (Analysis)
mid_y_vec <- (steps$ymin + steps$ymax) / 2
x_out <- a_xmax + 0.08

right_connect <- data.frame(
  x    = rep(a_xmax, n_boxes - 1),
  y    = mid_y_vec[1:(n_boxes-1)],
  xend = rep(x_out,  n_boxes - 1),
  yend = mid_y_vec[1:(n_boxes-1)]
)
vertical_arrows <- data.frame(
  x    = rep(x_out, n_boxes - 1),
  y    = mid_y_vec[1:(n_boxes-1)] - 0.05,
  xend = rep(x_out, n_boxes - 1),
  yend = mid_y_vec[2:n_boxes] + 0.05
)
left_connect <- data.frame(
  x    = rep(x_out,  n_boxes - 1),
  y    = mid_y_vec[2:n_boxes],
  xend = rep(a_xmax, n_boxes - 1),
  yend = mid_y_vec[2:n_boxes]
)

# ----------------------------
# Arrow: Response -> top Analysis box
# ----------------------------
resp_to_analysis <- data.frame(
  x    = resp_xmax + 0.02,
  y    = (resp_ymin + resp_ymax)/2,
  xend = a_xmin - 0.02,
  yend = (steps$ymin[1] + steps$ymax[1]) / 2
)

# ----------------------------
# Legend
# ----------------------------
legend_data <- data.frame(
  xmin  = c(3.1, 4.4),
  xmax  = c(4.7, 6.0),
  ymin  = c(0.95, 0.95),
  ymax  = c(1.35, 1.35),
  fill  = c("lightgray", "#cfe2ff"),
  label = c("Not Used", "Used")
)

# ----------------------------
# Draw
# ----------------------------
p <- ggplot() +
  # Columns
  geom_rect(
    data = columns,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,
        fill = fill, color = border)
  ) +
  scale_fill_identity() + scale_color_identity() +
  # Column labels
  geom_text(
    data = columns,
    aes(x = (xmin + xmax)/2, y = ymax + 0.7, label = label),
    size = 3, vjust = 1
  ) +
  # Gutters
  geom_rect(
    data = gutters,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    fill = "white", color = NA
  ) +
  # Response box
  geom_rect(
    data = resp_steps,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    fill = "white", color = "black"
  ) +
  geom_text(
    data = resp_steps,
    aes(x = (xmin + xmax)/2, y = (ymin + ymax)/2, label = label),
    size = 2.6, lineheight = 1.05
  ) +
  # Analysis boxes
  geom_rect(
    data = steps,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    fill = "white", color = "black"
  ) +
  geom_text(
    data = steps,
    aes(x = (xmin + xmax)/2, y = (ymin + ymax)/2, label = label),
    size = 2.7, lineheight = 1.08
  ) +
  # Outside arrows
  geom_segment(data = right_connect, aes(x = x, y = y, xend = xend, yend = yend),
               linewidth = 0.5, color = "black") +
  geom_segment(data = vertical_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               arrow = arrow(length = unit(6, "pt"), type = "closed"),
               linewidth = 0.5, color = "black") +
  geom_segment(data = left_connect, aes(x = x, y = y, xend = xend, yend = yend),
               linewidth = 0.5, color = "black") +
  # Arrow Response -> Analysis
  geom_curve(
    data = resp_to_analysis,
    aes(x = x, y = y, xend = xend, yend = yend),
    curvature = 0.1,
    arrow = arrow(length = unit(6, "pt"), type = "closed"),
    linewidth = 0.6
  ) +
  # Legend
  geom_rect(
    data = legend_data,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill),
    color = "black"
  ) +
  geom_text(
    data = legend_data,
    aes(x = (xmin + xmax)/2, y = ymin - 0.15, label = label),
    size = 3.1, vjust = 1
  ) +
  coord_cartesian(xlim = c(0, 9.0), ylim = c(0.6, 10.9), expand = FALSE) +
  theme_void() +
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.margin = margin(10, 20, 36, 20)
  )

p



```

# East Horizon Simulation Setup

To recreate this example for yourself, create a new project in East Horizon using the Continuous endpoint type. Next create an input set using the explore option.

<div style="background-color:#bfbfbf; padding:10px; border-radius:6px;">

<div class="alert alert-primary" role="alert">
  <p style="margin-bottom:0">
    This setup uses <a href="https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/AnalyzeMMRM.R" class="alert-link">AnalyzeMMRM.R</a> 
    but it also applies to 
    <a href="https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/RCode/AnalyzeMMRM_GLS.R" class="alert-link">AnalyzeMMRM_GLS.R</a>
  </p>
</div>

</div>




## Designs: 



MMRM fixed‑sample (baseline N ~266) and group‑sequential MMRM in the sample size box insert 200:360:20 (this will create sample from 200 to 360 in steps of 20) (both at Type I error 0.025 and an allocation ratio of 1). for the test box, insert the AnalyzeMMRM.R file. In total, there should be 2 design cards.

Below your design cards should look something like this:

<br>

**MMRM Fixed Sample:**
![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Write up Screenshots\Screenshot 2025-09-17 180225.png){width=90%}
 <br><br><br>
 
**MMRM Group Sequential:**
![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Write up Screenshots\Screenshot 2025-09-17 180607.png){width=90%}
<br><br><br>

## Responses: 
There should be a total of 6 different response cards. The first card should use the data use the data given from the publication on the mean differences between treatment and control arms (Mead Difference = 6 points) and the given standard deviation (Std. Dev = 15). There should be two cards called Difference 4, 8 these cards will change the mean difference between the arms to 4 and 8 respectively. Next, there should be two response cards that change the standard deviation from 15 to 10 and 20. Lastly, there should be a null card where the standard deviation is 15 but the mean difference between treatment and control are the same. All of these cards for their distribution should use the GenerateMMRM.R file.

Below are the response cards and how they should look:

<br>

**Response card using data from the publication:**
![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Write up Screenshots\Screenshot 2025-09-17 181914.png){width=90%}
<br><br><br>

**Null case card:**
![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Write up Screenshots\Screenshot 2025-09-17 182112.png){width=90%}
<br><br><br>

**Difference cards 4 and 8 respectively:**
![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Write up Screenshots\Screenshot 2025-09-17 183125.png){width=90%}
![](C:\Users\jacob.wathen\OneDrive - Cytel\Pictures\Screenshots\Write up Screenshots\Screenshot 2025-09-17 182112.png){width=90%}

## Dropout & Enrollment:
Shared dropout card (from publication assumptions); total N grid from 200 to 360 in steps of 50 for MMRM.

# Results (Selected Highlights)

- **Target power**: ≈90% power achieved with ~190 completers at SD = 15 (implies larger randomized N depending on dropout).
- **Sensitivity**: Power changed as SD and mean difference were varied (SD ↑ → power ↓; SD ↓ → power ↑).
- **Null behavior (R MMRM)**: Type I error around 2.1–3.6%, close to nominal 2.5%.
- **Group‑sequential caution (EH)**: Using native East Horizon group‑sequential analysis inflated the null rejection rate (e.g., ~17.6% vs. 2.5% expected). Prefer validated MMRM implementations or investigate analysis settings.

# Discussion

- **Model choice**: MMRM is well‑suited for longitudinal continuous outcomes with missing‑at‑random assumptions; it uses all available post‑baseline data without LOCF and models the mean profile over time.
- **Practicalities**: Reshaping (wide→long), baseline adjustment, visit factorization, and correlation structure (e.g., AR(1)) are standard components.
- **Visualization**: Trial‑level mean trajectories with 95% CIs and optional patient‑level plots help QC data generation.
- **Platform differences**: Ensure parity in estimands, covariance structures, and decision rules between R and East Horizon; verify Type I error control under the null when using group‑sequential options.


