---
title: '**MMRM Analysis**'
author: "Jacob Wathen"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 5
    number_sections: true
    latex_engine: tinytex
  word_document: default
  pdf_document:
    toc: true
    toc_depth: '5'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library( CyneRgy )
```


# **Introduction**
Many clinical trials often involve repeated measures of a continuous endpoint across multiple visits. Due to the burden on the trial subjects, data can be missing for a variety of reasons such as missed visits or patient dropout.  Efficiently, analyzing this type of data requires methods that handle within-patient correlation and missing data appropriately. 

The **Mixed Model for Repeated Measures (MMRM)** is widely used because it provides opportunity to:  
-  Adjusts for baseline and visit effects,  
-  Accounts for correlation between repeated observations,  
-  Avoids simplistic imputation approaches such as LOCF (Last Observation Carried Forward).  

This example has two goals:  
1. **East Horizon R Integration Scripts** Create the R scripts for analyzing data employing a MMRM approach and simulating trial data.  
2. **Compare MMRM to Native East Horizon Analysis**  Compare the different analysis approaches to understand potential gains from using an MMRM

Together, this example provides a foundation for trial designers to estimate power, evaluate operating characteristics, and explore design choices in schizophrenia studies using an additional analysis that are not native to East Horizon.

# **Required Files**

Before running anything in East Horizon, load the Schizophrenia example by installing CyneRgy and running this command into RStudio:

```{r, eval=FALSE}
CyneRgy::RunExample( "SchizophreniaTrial" )
```

Running this code above will load the RStudio project.

**RStudio Project File**: SchizophreniaTrial.Rproj

This project has the required R code files needed to simulate, analyze, plot, and run patient data. Below in the R code folder, there should be the following files:

[AnalyzeMMRM.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/AnalyzeMMRM.R) -  This code takes simulated patient data and run analysis.

[AnalyzeMMRM_GLS.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/AnalyzeMMRM_GLS.R) -  This code is a slower version of the original analysis, but it has slightly increased power and an alternative form of analysis.

[GenerateMMRMResponses.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/GenerateMMRMResponses.R) -  This code generates the responses for patients across treatment visits.

[PlotPatientData.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/PlotPatientData.R) -  This code takes the generated patient data and can plot individual patient trajectories.

[PlotTrialdata.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/PlotTrialData.R) -  This code takes the overall data generated and creates a plot of the difference of means with a 95% CI.

[RunSimulation.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/RunSimulation.R) -  This code allows for the code to be run locally, change variables around, and visualize data.  It can helpful to run the R code locally before uploading to East Horizon (EH) to make sure no bugs are present if changes are made to the code. 

This example looks into an analysis using MMRM. It allows for dropout information to not impact power as much as other analysis methods. It works well in East Horizon (EH) for providing a longitudinal analysis design.  While not all of the R files listed above are required, they can be used to help simulate patient data and run analysis locally in R Studio.  This can be very helpful to allow users a good starting point in case they need to adjust the details in the analysis.  The various plot functions can be very helpful for visualizing the simulated patient data to make sure it looks realistic. 

For EH, you will need AnalyzeMMRM.R and/or AnalyzeMMRM_GLS.R for the MMRM analysis.  Both files provide MMRM analysis but use different R packages and the AnalyzeMMRM.R file has the most efficient approach.  Additionally, the GenerateMMRMResponses.R file provides a R function for patient generation that can be used in EH, but it is not required as the native approach to data generation could be used.


## Example outputs 

Below are some graphs as example outputs from the code from the GenerateMMRResponse function.  It it always good to review example data sets to verify that they the data is realistic. 

 <br><br><br>
<span style="font-size:15pt">**Figure 1**: An example plot of the trial data with a 95% CI</span>

![](Schizophrenia_Files/TrialPlot.png){width=90%}

 <br><br><br>
<span style="font-size:15pt">**Figure 2**: An example plot of individual patient trajectories</span>
![](Schizophrenia_Files/PatientPlot.png){width=90%}

# **Flowchart of Clinical Trial Process**

The flowchart below shows the points of R integration in Cytel products, and it outlines the steps performed by the R code.


```{r flowchart_response_box_wider, fig.width=10, fig.height=6, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(grid)

# ----------------------------
# Layout controls
# ----------------------------
ymin_band  <-  2
ymax_band  <-  10
wrap_width <-  32
wrap_resp  <-  34   # allow wider wrapping for Response
gutter_w   <-  0.08

# ----------------------------
# Columns
# ----------------------------
columns <-  data.frame(
  xmin   = c(0, 1, 2, 3, 4, 5, 6),
  xmax   = c(1, 2, 3, 4, 5, 6.75, 8.5),  # Response widened (5→6.75)
  ymin   = ymin_band,
  ymax   = ymax_band,
  label  = c("Initialization","Enrollment","Randomization","Dropout",
             "Treatment\nSelection","Response","Analysis"),
  used   = c(FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE)
)
columns$fill   <-  ifelse(columns$used, "#cfe2ff", "lightgray")
columns$border <-  columns$fill

# Gutters (keep uniform spacing)
gutters_x <-  c(1, 2, 3, 4, 5, 6.75, 8.5)
gutters <-  data.frame(
  xmin = gutters_x -  gutter_w/2,
  xmax = gutters_x + gutter_w/2,
  ymin = ymin_band,
  ymax = ymax_band
)

# ----------------------------
# Response box (wider)
# ----------------------------
resp_xmin <-  5.1
resp_xmax <-  6.65   # widened width
resp_ymin <-  6.0
resp_ymax <-  8.5

wrap_text <-  function(s, width) paste(strwrap(s, width = width), collapse = "\n")
resp_label <-  wrap_text(
  "Generates the responses of each patient at each time point (visit), depending on the patient’s treatment",
  width = wrap_resp
)

resp_steps <-  data.frame(
  xmin  = resp_xmin,
  xmax  = resp_xmax,
  ymin  = resp_ymin,
  ymax  = resp_ymax,
  label = resp_label
)

# ----------------------------
# Analysis boxes (4 boxes)
# ----------------------------
a_xmin <-  6.9
a_xmax <-  8.35

labels_raw <-  c(
  "Takes the generated data and runs analysis",
  "Extracts treatment effect",
  "Uses the rpact package to find the alpha so it can be used for decision rules",
  "Returns the decision, p-value, error code, and prime delta"
)
labels_wrapped <- vapply(labels_raw, wrap_text, character(1), width = wrap_width)

n_boxes <-  4
top_y   <-  9.5
bot_y   <-  2.5
gap     <-  0.22
box_h   <-  (top_y -  bot_y - gap*(n_boxes-1)) / n_boxes

steps <- data.frame(
  xmin  = a_xmin,
  xmax  = a_xmax,
  ymin  = seq(from = top_y - box_h, by = -(box_h + gap), length.out = n_boxes),
  ymax  = seq(from = top_y,         by = -(box_h + gap), length.out = n_boxes),
  label = labels_wrapped
)

# Outside arrows (Analysis)
mid_y_vec <- (steps$ymin + steps$ymax) / 2
x_out <- a_xmax + 0.08

right_connect <- data.frame(
  x    = rep(a_xmax, n_boxes - 1),
  y    = mid_y_vec[1:(n_boxes-1)],
  xend = rep(x_out,  n_boxes - 1),
  yend = mid_y_vec[1:(n_boxes-1)]
)
vertical_arrows <- data.frame(
  x    = rep(x_out, n_boxes - 1),
  y    = mid_y_vec[1:(n_boxes-1)] - 0.05,
  xend = rep(x_out, n_boxes - 1),
  yend = mid_y_vec[2:n_boxes] + 0.05
)
left_connect <- data.frame(
  x    = rep(x_out,  n_boxes - 1),
  y    = mid_y_vec[2:n_boxes],
  xend = rep(a_xmax, n_boxes - 1),
  yend = mid_y_vec[2:n_boxes]
)

# ----------------------------
# Arrow: Response -> top Analysis box
# ----------------------------
resp_to_analysis <- data.frame(
  x    = resp_xmax + 0.02,
  y    = (resp_ymin + resp_ymax)/2,
  xend = a_xmin - 0.02,
  yend = (steps$ymin[1] + steps$ymax[1]) / 2
)

# ----------------------------
# Legend
# ----------------------------
legend_data <- data.frame(
  xmin  = c(3.1, 4.4),
  xmax  = c(4.7, 6.0),
  ymin  = c(0.95, 0.95),
  ymax  = c(1.35, 1.35),
  fill  = c("lightgray", "#cfe2ff"),
  label = c("Not Used", "Used")
)

# ----------------------------
# Draw
# ----------------------------
p <- ggplot() +
  # Columns
  geom_rect(
    data = columns,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax,
        fill = fill, color = border)
  ) +
  scale_fill_identity() + scale_color_identity() +
  # Column labels
  geom_text(
    data = columns,
    aes(x = (xmin + xmax)/2, y = ymax + 0.7, label = label),
    size = 3, vjust = 1
  ) +
  # Gutters
  geom_rect(
    data = gutters,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    fill = "white", color = NA
  ) +
  # Response box
  geom_rect(
    data = resp_steps,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    fill = "white", color = "black"
  ) +
  geom_text(
    data = resp_steps,
    aes(x = (xmin + xmax)/2, y = (ymin + ymax)/2, label = label),
    size = 2.6, lineheight = 1.05
  ) +
  # Analysis boxes
  geom_rect(
    data = steps,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
    fill = "white", color = "black"
  ) +
  geom_text(
    data = steps,
    aes(x = (xmin + xmax)/2, y = (ymin + ymax)/2, label = label),
    size = 2.7, lineheight = 1.08
  ) +
  # Outside arrows
  geom_segment(data = right_connect, aes(x = x, y = y, xend = xend, yend = yend),
               linewidth = 0.5, color = "black") +
  geom_segment(data = vertical_arrows, aes(x = x, y = y, xend = xend, yend = yend),
               arrow = arrow(length = unit(6, "pt"), type = "closed"),
               linewidth = 0.5, color = "black") +
  geom_segment(data = left_connect, aes(x = x, y = y, xend = xend, yend = yend),
               linewidth = 0.5, color = "black") +
  # Arrow Response -> Analysis
  geom_curve(
    data = resp_to_analysis,
    aes(x = x, y = y, xend = xend, yend = yend),
    curvature = 0.1,
    arrow = arrow(length = unit(6, "pt"), type = "closed"),
    linewidth = 0.6
  ) +
  # Legend
  geom_rect(
    data = legend_data,
    aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax, fill = fill),
    color = "black"
  ) +
  geom_text(
    data = legend_data,
    aes(x = (xmin + xmax)/2, y = ymin - .15, label = label),
    size = 3.1, vjust = 1
  ) +
  coord_cartesian(xlim = c(0, 9.0), ylim = c(0.6, 10.9), expand = FALSE) +
  theme_void() +
  theme(
    panel.background = element_rect(fill = "white", colour = "white"),
    plot.margin = margin(10, 20, 36, 20)
  )

p



```

# **East Horizon Simulation Setup**

To recreate this example in EH, begin by creating a new project in EH using a Study Objective of "Two Arm Confirmatory." On the Plan page, select the Continuous endpoint type. After selecting the continuous endpoint, choose the "Repeated Measure" option and click "Add Visit" so that the project will have a total of 5 visits: 4 interim visits and 1 final visit. 

The visit times should be set as follows:
- Visit 1: 0
- Visit 2: 0.25
- Visit 3: 0.5
- Visit 4: 0.75
- Final Visit: 1

For Better Response, select "Small Value," since a patient's outcome is improved with a smaller score. The project setup should look like the following.

<span style="font-size:15pt">**Project Setup**:</span>
![](Schizophrenia_Files/ProjectSetup.png){width=90%}

Once you "Create Project", you then need to create an input set using the explore option.  When setting up the project details, make sure to select the option to have repeated measurements and specify the times of the visits. 

## Designs: 

MMRM fixed‑sample (baseline N ~266) and group‑sequential MMRM in the sample size box insert 200:360:20 (this will create sample sizes ranging from 200 to 360 in steps of 20) (both at Type I error 0.025 and an allocation ratio of 1). For the Test type, select User Defined R, then upload the  [AnalyzeMMRM.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/AnalyzeMMRM.R).  

**Below your design card for the fixed design should look something like this**:

<br>

<span style="font-size:15pt">**MMRM Fixed Sample**:</span>
![](Schizophrenia_Files/MMRMFixed.png){width=90%}
 <br><br><br>
 To add a group sequential option, you can duplicate the card so that the sample sizes are retained.  Switch the Statistical Design to Group Sequential.  The card should look like:
 <br><br>
<span style="font-size:15pt">**MMRM Group Sequential**:</span>
![](Schizophrenia_Files/MMRMGS.png){width=90%}
<br><br><br>

## Responses: 
For this example, we create a total of 6 different response cards. The first card use the result data from  Correll *et. al. * for the mean differences between treatment and control arms (Mead Difference = 6 points) and the given standard deviation (Std. Dev = 15). There should be two cards called Difference 4, 8 these cards will change the mean difference between the arms to 4 and 8 respectively. Next, there should be two response cards that change the standard deviation from 15 to 10 and 20.  The different standard deviations and mean different are included to understand the impact on power.  Lastly, there should be a null card where the standard deviation is 15 but the mean difference between treatment and control are the same. The null case is used to understand the false-positive of each analysis method. 

All cards use the R integration and the [GenerateMMRMResponses.R](https://github.com/Cytel-Inc/CyneRgy/blob/304-create-mmrm-analysis-example-for-clinical-trial/inst/Examples/SchizophreniaTrial/R/GenerateMMRMResponses.R) file can be uploaded..

**Below are the response cards and how they should look**:

<br>


<span style="font-size:15pt">**Response card using data from the publication**:</span>
![](Schizophrenia_Files/PublicationResponse.png){width=90%}
<br><br><br>

<span style="font-size:15pt">**Null Case Card**:</span>

![](Schizophrenia_Files/NullResponse.png){width=90%}
<br><br><br>

<span style="font-size:15pt">**Difference cards 4 and 8 respectively**:</span>
![](Schizophrenia_Files/MeanDiff4.png){width=90%}
![](inst/Examples/SchizophreniaTrial/Schizophrenia_Files/Diff8Response.png){width=90%}
<br><br><br>

<span style="font-size:15pt">**Standard deviation cards 10 and 20 respectively**:</span>
![](Schizophrenia_Files/StdDev10.png){width=90%}
![](Schizophrenia_Files/StdDev20.png){width=90%}

<br><br><br>

## Dropout & Enrollment:
All dropout cards share the same dropout rates as the publication (0.26 control and 0.15 experimental). Next, there should be one enrollment card with a rate of 30 subjects per month. Once all of these are set up, go to simulation setup and select 1000 repetitions.

**Here are what the dropout and enrollment cards should look like**:
<br><br>

<span style="font-size:15pt">**Dropout Information**:</span>
![](Schizophrenia_Files/DropoutRate.png){width=90%}
<br><br><br>


<span style="font-size:15pt">**Enrollment card**:</span>
![](Schizophrenia_Files/Enrollment.png){width=90%}
<br><br><br>

#  **Results**


- **Target power**: Approximately 90% power is achieved with about 266 completers when the standard deviation is 15 and the mean difference is 6. For reaching this power there are 2 designs that effectively accomplish this. One should be the MMRM fixed design and the other being MMRM Group-sequential with a sample size of 300. Either of these designs are viable and the trade off will be discussed in the results discussion section.

<br><br><br>

<span style="font-size:15pt">**Figure 3**: Publication Results</span>
![](Schizophrenia_Files/PublicationResults.png){width=100%}
<br><br><br>

- **Sensitivity**: Power changed as standard deviation and mean difference were varied (Std. Dev ↑ → power ↓; Std. Dev ↓ → power ↑).The standard deviation 20 cards and the mean difference 4 cards resulted in significantly lower power ranging 36%-76%. As for the standard deviation 10 and mean difference 8 cards, the powers came out substantially higher where all designs ranged from 95%-100% power.

<br><br><br>

<span style="font-size:15pt">**Figure 4**: Difference of Means Results</span>
![](Schizophrenia_Files/MeanDiff4_8Results.png)
<br><br><br>

<span style="font-size:15pt">**Figure 5**: Standard Deviation Results</span>

![](Schizophrenia_Files/SD10_20Results.png)
<br><br><br>

- **Null behavior (MMRM)**: Type I error around 2.1–3.6%, close to nominal 2.5%.

<br><br><br>

<span style="font-size:15pt">**Figure 6**: Null Case Results</span>

![](Schizophrenia_Files/NullResult.png)




#  **Discussion**

-  **Fixed Vs. selected Sample**: While the selected design (i.e., the group-sequential design that allows for interim analyses and potential early stopping) does feature a lower power than the fixed sample, it does come with several benefits worth weight when simulating the study. The selected design boasts a 30% chance of stopping early, a shorter average study duration, and smaller average sample size. In return, it comes with a decrease in power by ~1.4%. These difference are significant as it can save money in a trial for even one of these other improved results.
![](Schizophrenia_Files/SelectDesign.png)
<br><br><br>

-  **Sensitivity Analysis**: The reason for including the difference of means cards and the standard deviation cards was to illustrate how sensitive the power in this study is if the researchers' initial assumptions were off. When increasing standard deviation to 20 or decreasing the difference of means to 4 led to the power becoming under powered. This means we would have to increase the sample size to detect if there is a significant difference. As for the standard deviation 10 and difference of means 8 cards, the power dramatically increased to the mid-high 90's range. This would allow for the sample size of the study to be shrunk down and still maintain a 90% power.
-  **Null Cases**: The null cases all hovered around 2.1%-3.6%. These percentages fall within a tolerable range. This demonstrates that the MMRM analysis code only detects a false positive rate of approximately 2.5%, which matches the originally specified type I error.




# **Conclusion**
This work successfully built and validated an MMRM analysis framework in both R and East Horizon. The R pipeline enables transparent simulation, analysis, and visualization, while East Horizon supports large-scale scenario evaluation. Together, they provide trial designers with flexible tools to plan studies, anticipate power, and identify risks.  

The findings confirm MMRM’s suitability for longitudinal endpoints and highlight areas for further improvement, particularly around sequential testing and dropout handling. Through the R integration for analysis we have added an MMRM analysis that can better support clinical trial decision-making and design optimization than the native analysis option in EH for this particular trial example.



# **Reference**
Correll CU, Davis RE, Weingart M, et al. Efficacy and Safety of Lumateperone for Treatment of Schizophrenia: A Randomized Clinical Trial. JAMA Psychiatry. 2020;77(4):349–358. [doi:10.1001/jamapsychiatry.2019.4379](https://jamanetwork.com/journals/jamapsychiatry/fullarticle/2758022)
 
